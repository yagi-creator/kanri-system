<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="塾入金管理">
    <meta name="theme-color" content="#007bff">
    <title>塾入金管理システム v3.1 完全統合版</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* ========================================
           基本スタイル・統合版
           ======================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, 'Segoe UI', 'ヒラギノ角ゴ ProN', Meiryo, sans-serif;
            background-color: #f5f7fb;
            color: #333;
            line-height: 1.6;
            -webkit-user-select: none;
            user-select: none;
        }

        input, textarea, .phone-number {
            -webkit-user-select: text;
            user-select: text;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ========================================
           ログイン画面
           ======================================== */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-box {
            background: white;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.12);
            width: 100%;
            max-width: 420px;
        }

        .login-box h2 {
            text-align: center;
            margin-bottom: 18px;
            color: #333;
            font-size: 24px;
        }

        .subtitle {
            text-align: center;
            font-size: 13px;
            color: #666;
            margin-bottom: 20px;
        }

        .complete-badge {
            background: #28a745;
            color: white;
            padding: 3px 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 8px;
        }

        /* ========================================
           フォーム要素
           ======================================== */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            background: #fff;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        /* ========================================
           ボタンスタイル
           ======================================== */
        .btn {
            display: inline-block;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            color: white;
            background: #007bff;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            line-height: 1;
            transition: all 0.2s ease;
            min-height: 44px;
            text-decoration: none;
            -webkit-tap-highlight-color: transparent;
        }

        .btn:hover { filter: brightness(0.95); transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        .btn-primary { background: #007bff; }
        .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-info { background: #17a2b8; }
        .btn-secondary { background: #6c757d; }
        .btn-outline-primary { color: #007bff; border: 1px solid #007bff; background: transparent; }
        .btn-outline-primary:hover { background: #007bff; color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; min-height: 32px; }

        .login-btn { width: 100%; }

        .info-note {
            font-size: 12px;
            margin-top: 15px;
            padding: 12px;
            background: #e3f2fd;
            border-radius: 6px;
            color: #1565c0;
            text-align: center;
        }

        /* ========================================
           メインコンテンツ
           ======================================== */
        .main-content { display: none; }

        .header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }

        .header h1 { margin: 0; font-size: 22px; }
        .version-info { font-size: 12px; opacity: 0.9; margin-top: 4px; }
        .user-info { text-align: right; }
        .user-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            align-items: center;
            justify-content: flex-end;
        }

        .header-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            min-height: 36px;
            font-size: 13px;
            transition: background-color 0.3s;
        }

        .header-btn:hover { background: rgba(255,255,255,0.3); }
        .header-btn.btn-danger-header { background: rgba(220, 53, 69, 0.9); }
        .header-btn.btn-danger-header:hover { background: rgba(220, 53, 69, 1); }

        /* ========================================
           パネルスタイル
           ======================================== */
        .panel {
            background: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .panel h3 {
            margin-bottom: 20px;
            color: #007bff;
            font-size: 18px;
        }

        .settings-panel { display: none; }

        .settings-row {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .settings-row label {
            width: 140px;
            font-weight: 600;
            font-size: 14px;
        }

        .settings-row input, .settings-row select {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        /* ========================================
           統計・操作
           ======================================== */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            text-align: center;
            transition: transform 0.2s ease;
        }

        .stat-card:hover { transform: translateY(-2px); }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        .control-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .sort-active {
            background: #0056b3 !important;
            color: white !important;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0, 86, 179, 0.3);
        }

        .search-input {
            width: 100%;
            padding: 14px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        /* ========================================
           テーブル・カード
           ======================================== */
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
        }

        th {
            background: #f8f9fa;
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.2s ease;
        }

        th:hover { background: #e9ecef; }

        td {
            padding: 14px 12px;
            border-bottom: 1px solid #dee2e6;
            font-size: 13px;
        }

        tr:hover { background: #f8f9fa; }

        .overdue-red { color: #dc3545; font-weight: bold; }
        .overdue-pink-row { background-color: #ffe6ea !important; }
        .overdue-pink-row:hover { background-color: #ffd6e0 !important; }
        .completed-gray-row { background: #e9ecef !important; color: #6c757d; }
        .completed-gray-row:hover { background: #dee2e6 !important; }
        .amount-display { font-size: 1.1em; font-weight: bold; color: #007bff; }

        .phone-contact {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .phone-contact .phone-number {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        /* ========================================
           アクションボタン
           ======================================== */
        .action-btn {
            padding: 8px 12px;
            margin: 2px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            min-height: 36px;
            min-width: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .action-btn:hover { transform: translateY(-1px); }
        .phone-btn { background: #28a745; color: white; }
        .edit-btn { background: #ffc107; color: #212529; }
        .delete-btn { background: #dc3545; color: white; }
        .history-btn { background: #17a2b8; color: white; }

        /* ========================================
           モーダル
           ======================================== */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: auto;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .close:hover { color: #000; background: #f0f0f0; }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row .form-group { flex: 1; }

        /* ========================================
           カードビュー（モバイル）
           ======================================== */
        .card-container { display: none; }

        .juku-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-left: 4px solid #007bff;
            transition: transform 0.2s ease;
        }

        .juku-card:hover { transform: translateY(-2px); }
        .juku-card.overdue-pink { background-color: #ffe6ea; border-left-color: #dc3545; }
        .juku-card.completed-gray { background: #e9ecef; border-left-color: #6c757d; color: #6c757d; }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #eee;
        }

        .card-school-name { font-size: 1.2em; font-weight: bold; color: #333; }
        .card-amount { font-size: 1.4em; font-weight: bold; color: #007bff; }

        .card-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .card-info-label { font-weight: bold; color: #666; min-width: 80px; }

        .card-overdue {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .card-overdue.normal { background: #e3f2fd; color: #1976d2; }
        .card-overdue.warning { background: #fff3e0; color: #f57c00; }
        .card-overdue.danger { background: #ffebee; color: #d32f2f; }

        .card-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #eee;
        }

        .card-action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            min-height: 44px;
            -webkit-tap-highlight-color: transparent;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .card-action-btn:hover { transform: translateY(-1px); }
        .card-phone-btn { background: #28a745; color: white; }
        .card-phone-btn:disabled { background: #6c757d; opacity: 0.5; transform: none; }
        .card-edit-btn { background: #ffc107; color: #212529; }
        .card-history-btn { background: #17a2b8; color: white; }

        /* ========================================
           履歴
           ======================================== */
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .history-table th {
            background: #f8f9fa;
            padding: 12px 10px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
        }

        .history-table td {
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
            font-size: 12px;
        }

        .mobile-history { display: none; }

        .mobile-history-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid #007bff;
        }

        .mobile-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .mobile-history-date { font-weight: bold; color: #007bff; font-size: 0.9em; }
        .mobile-history-editor { font-size: 0.8em; color: #666; }
        .mobile-history-field { font-weight: bold; color: #333; margin-bottom: 6px; }

        .mobile-history-change {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.9em;
        }

        .mobile-history-old { color: #dc3545; text-decoration: line-through; }
        .mobile-history-new { color: #28a745; font-weight: bold; }
        .mobile-history-arrow { color: #666; }

        /* ========================================
           ユーティリティ
           ======================================== */
        .empty-state {
            background: white;
            padding: 60px 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            display: none;
        }

        .empty-state h3 { color: #666; margin-bottom: 15px; font-size: 20px; }
        .empty-state p { color: #999; margin-bottom: 25px; font-size: 16px; }

        .error-message, .success-message {
            margin-top: 15px;
            font-size: 14px;
            text-align: center;
            border-radius: 6px;
            padding: 12px;
        }

        .error-message {
            color: #dc3545;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            display: none;
        }

        .success-message {
            color: #155724;
            background: #d4edda;
            border: 1px solid #c3e6cb;
        }

        .sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 123, 255, 0.95);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 13px;
            font-weight: 500;
            z-index: 999;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .sync-indicator.success { background: rgba(40, 167, 69, 0.95); }
        .sync-indicator.error { background: rgba(220, 53, 69, 0.95); }

        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ========================================
           レスポンシブデザイン
           ======================================== */
        @media (max-width: 768px) {
            .container { padding: 12px; }
            .header { flex-direction: column; text-align: center; padding: 16px; }
            .user-info { margin-top: 15px; }
            .user-actions { flex-direction: column; gap: 8px; }
            .header-btn { width: 150px; }
            .control-buttons { flex-direction: column; }
            .btn { width: 100%; margin-bottom: 8px; min-height: 44px; }
            .form-row { flex-direction: column; }
            .table-container { display: none; }
            .card-container { display: block; }
            .history-table { display: none; }
            .mobile-history { display: block; }
            .modal-content { margin: 2% auto; width: 95%; max-height: 90vh; padding: 20px; }
            .login-box { margin: 20px; padding: 24px; }
            .stats { grid-template-columns: 1fr 1fr; gap: 12px; }
            .stat-card { padding: 16px; }
            .stat-value { font-size: 22px; }
        }
    </style>
</head>
<body>
    <div id="syncIndicator" class="sync-indicator"></div>

    <!-- ログイン画面 -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h2>塾入金管理システム v3.1 <span class="complete-badge">完全統合版</span></h2>
            <div class="subtitle">ID・パスワードでログイン</div>
            
            <div class="form-group">
                <label for="username">ユーザーID</label>
                <input id="username" type="text" placeholder="例）taniguchi" autocomplete="username">
            </div>
            <div class="form-group">
                <label for="password">パスワード</label>
                <input id="password" type="password" placeholder="パスワード" autocomplete="current-password">
            </div>
            <button class="btn btn-primary login-btn" onclick="login()">ログイン</button>
            
            <div id="loginError" class="error-message"></div>
            
            <div class="info-note">
                <strong>📋 初回セットアップガイド</strong><br>
                まず「接続設定」でApps ScriptのWebアプリURLを設定してください。<br>
                設定後、ID・パスワード認証でログインできます。<br>
                <small style="opacity: 0.8;">※スマホ編集履歴取得エラー修正済み</small>
            </div>
        </div>
    </div>

    <!-- メイン画面 -->
    <div id="mainScreen" class="main-content">
        <div class="container">
            <!-- ヘッダー -->
            <div class="header">
                <div>
                    <h1>塾入金管理システム v3.1 <span class="complete-badge">完全統合版</span></h1>
                    <div class="version-info">Code.gs v3.1完全対応・HTTPメソッド自動切替・スマホエラー修正済み</div>
                    <div id="lastEditInfo" style="font-size: 13px; opacity: 0.9; margin-top: 4px;">最終編集: -</div>
                </div>
                <div class="user-info">
                    <div id="currentUserName" style="font-weight: bold; font-size: 16px;"></div>
                    <div id="currentUserRole" style="font-size: 14px;"></div>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 2px;">🔑 ID・パスワード認証</div>
                    <div class="user-actions">
                        <button class="header-btn btn-danger-header" onclick="resetLocalData()" id="btnResetLocal">🗑️ データ削除</button>
                        <button class="header-btn" onclick="logout()">ログアウト</button>
                    </div>
                </div>
            </div>

            <!-- 統計情報 -->
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalRecords">0</div>
                    <div class="stat-label">有効データ数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalAmount">¥0</div>
                    <div class="stat-label">総未収金額</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="overdueCount">0</div>
                    <div class="stat-label">期限超過</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="dueSoonCount">0</div>
                    <div class="stat-label">期限間近</div>
                </div>
            </div>

            <!-- 接続設定パネル -->
            <div id="settingsPanel" class="panel settings-panel">
                <h3>🔗 接続設定 <span class="complete-badge">v3.1対応</span></h3>
                <div class="settings-row">
                    <label>Apps Script URL:</label>
                    <input type="text" id="sheetsUrl" placeholder="https://script.google.com/macros/s/.../exec">
                </div>
                <div class="settings-row">
                    <label>自動更新間隔:</label>
                    <select id="autoUpdateInterval">
                        <option value="0">手動のみ</option>
                        <option value="30000" selected>30秒</option>
                        <option value="60000">1分</option>
                        <option value="300000">5分</option>
                    </select>
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-info" onclick="syncFromSheets()">🔄 今すぐ同期</button>
                    <button class="btn btn-success" onclick="saveSettings()">💾 設定保存</button>
                    <button class="btn btn-secondary" onclick="hideSettings()">閉じる</button>
                    <span id="syncStatus" style="margin-left: 15px; font-weight: 500;"></span>
                </div>
                <div style="margin-top: 12px; font-size: 12px; color: #666; line-height: 1.5;">
                    ⚡ Code.gs v3.1簡素化版に対応したWebアプリURLを入力してください<br>
                    🔐 HTTPメソッド自動切替により、GET/POST処理を適切に振り分けます<br>
                    📱 スマホでの編集履歴取得エラーを完全修正済みです
                </div>
            </div>

            <!-- 操作メニュー -->
            <div class="panel">
                <h3>🎛️ 操作メニュー</h3>
                <div class="control-buttons">
                    <button class="btn btn-primary" onclick="showAddModal()" id="btnAddRecord">➕ 新規追加</button>
                    <button class="btn btn-success" onclick="exportToExcel()" id="btnExportExcel">📊 Excelエクスポート</button>
                    <button class="btn btn-info" onclick="showSettings()">⚙️ 接続設定</button>
                    
                    <button class="btn btn-info" onclick="sortByDueDate(true, this)">📅 期日近い順</button>
                    <button class="btn btn-secondary" onclick="sortByDueDate(false, this)">📅 期日遠い順</button>
                    <button class="btn btn-info" onclick="sortByLastUpdated(true, this)">🕒 更新新しい順</button>
                    <button class="btn btn-secondary" onclick="sortByLastUpdated(false, this)">🕒 更新古い順</button>
                    
                    <select id="assignedToFilter" onchange="updateAssignedToFilter()" class="btn btn-secondary" style="min-width: 150px;">
                        <option value="">担当者: 全て</option>
                    </select>
                    
                    <button class="btn btn-secondary" onclick="refreshData()">🔄 データ更新</button>
                    <button class="btn btn-danger" onclick="bulkDeleteCompleted()" id="btnBulkDelete">🗑️ 0円案件を一括削除</button>
                </div>
            </div>

            <!-- 検索 -->
            <div class="panel">
                <input type="text" class="search-input" id="searchInput" placeholder="🔍 検索（請求先名、担当者、電話番号、備考）" oninput="applyAllFilters()">
            </div>

            <!-- データなし表示 -->
            <div id="emptyState" class="empty-state">
                <h3>📝 データがありません</h3>
                <p>接続設定から同期するか、新規データを追加してください。</p>
                <button class="btn btn-info" onclick="showSettings()">⚙️ 接続設定</button>
            </div>

            <!-- テーブル表示（デスクトップ） -->
            <div class="table-container">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th onclick="sortTable(0)">請求先名</th>
                            <th onclick="sortTable(1)">未収金額</th>
                            <th onclick="sortTable(2)">期日</th>
                            <th onclick="sortTable(3)">超過日数</th>
                            <th onclick="sortTable(4)">入金予定日</th>
                            <th onclick="sortTable(5)">進捗</th>
                            <th onclick="sortTable(6)">担当</th>
                            <th onclick="sortTable(7)">電話番号</th>
                            <th onclick="sortTable(8)">最終更新</th>
                            <th onclick="sortTable(9)">備考</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>

            <!-- カード表示（モバイル） -->
            <div id="cardContainer" class="card-container"></div>
        </div>
    </div>

    <!-- 編集モーダル -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">新規追加</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="editForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>請求先名 *</label>
                        <input type="text" id="editSchoolName" required>
                    </div>
                    <div class="form-group">
                        <label>未収金額 *</label>
                        <input type="text" id="editAmount" required placeholder="例: 50000">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>期日 *</label>
                        <input type="date" id="editDueDate" required>
                    </div>
                    <div class="form-group">
                        <label>入金予定日</label>
                        <input type="date" id="editPaymentDate">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>進捗 *</label>
                        <select id="editProgress" required>
                            <option value="未対応">未対応</option>
                            <option value="架電不在">架電不在</option>
                            <option value="架電完了">架電完了</option>
                            <option value="メール済">メール済</option>
                            <option value="LINE済">LINE済</option>
                            <option value="入金済">入金済</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>担当者 *</label>
                        <select id="editAssignedTo" required>
                            <option value="">選択してください</option>
                            <option value="谷口">谷口</option>
                            <option value="島谷">島谷</option>
                            <option value="門戸">門戸</option>
                            <option value="梨木">梨木</option>
                            <option value="村上">村上</option>
                            <option value="八木">八木</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>電話番号</label>
                        <input type="tel" id="editPhone" placeholder="03-1234-5678">
                    </div>
                </div>
                <div class="form-group">
                    <label>備考</label>
                    <textarea id="editNotes" rows="3" placeholder="その他の情報やメモ"></textarea>
                </div>
                <div style="margin-top: 25px; text-align: right;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()" style="margin-right: 12px;">キャンセル</button>
                    <button type="submit" class="btn btn-primary">💾 保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 履歴モーダル -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>📋 編集履歴</h3>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button class="btn btn-sm btn-outline-primary" onclick="toggleHistorySort()" id="historySortBtn">
                        🔄 新しい順
                    </button>
                    <span class="close" onclick="closeHistoryModal()">&times;</span>
                </div>
            </div>
            <div id="historyContent">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>日時</th>
                            <th>編集者</th>
                            <th>項目</th>
                            <th>変更前</th>
                            <th>変更後</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody"></tbody>
                </table>
                <div id="mobileHistoryContainer" class="mobile-history"></div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // 塾入金管理システム v3.1 完全統合版（最終完成版）
        // Code.gs v3.1完全対応・HTTPメソッド自動切替・スマホエラー修正
        // ========================================

        // システム変数
        let currentUser = null;
        let allData = [];
        let filteredData = [];
        let editHistory = [];
        let sortColumn = -1;
        let sortDirection = 1;
        let editingIndex = -1;
        let autoUpdateTimer = null;
        let historyNewestFirst = true;
        let currentHistorySchool = null;
        let currentSearchTerm = '';
        let currentAssignedToFilter = '';
        let syncing = false;
        let schoolLastEditMap = new Map();

        // ========================================
        // 統一API呼び出し関数（HTTPメソッド自動切替対応）
        // ========================================

        /**
         * Apps ScriptへのAPI呼び出しを統一化（GET/POST自動切替）
         * スマホ編集履歴取得エラー修正対応
         */
        async function apiCall(action, data = {}) {
            const apiUrl = document.getElementById('sheetsUrl').value.trim();
            if (!apiUrl || !isAppsScriptUrl(apiUrl)) {
                throw new Error('Apps Script URLが設定されていません');
            }

            // 共通パラメータ
            const commonParams = {
                userEmail: currentUser ? (currentUser.email || currentUser.id) : '',
                userName: currentUser ? currentUser.name : '',
                sessionToken: currentUser ? currentUser.sessionToken : ''
            };

            // 読み取り系アクション（GETで送信）- Code.gs v3.1のdoGet()で処理
            const readActions = new Set(['getData', 'getHistory']);
            
            try {
                let response;
                
                if (readActions.has(action)) {
                    // GETリクエスト（読み取り系）
                    const params = new URLSearchParams({
                        action: action,
                        ...data,
                        ...commonParams
                    });
                    
                    response = await fetch(`${apiUrl}?${params.toString()}`, {
                        method: 'GET'
                    });
                } else {
                    // POSTリクエスト（変更系）- Code.gs v3.1のdoPost()で処理
                    const payload = {
                        action: action,
                        ...data,
                        ...commonParams
                    };
                    
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify(payload)
                    });
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                if (result.error) {
                    throw new Error(result.error);
                }
                
                return result;
                
            } catch (error) {
                console.error(`API呼び出しエラー (${readActions.has(action) ? 'GET' : 'POST'} ${action}):`, error);
                throw error;
            }
        }

        // ========================================
        // 認証システム（Code.gs v3.1対応）
        // ========================================

        /**
         * ID・パスワードログイン（サーバーサイド認証）
         */
        async function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');

            if (!username || !password) {
                showError(errorDiv, 'ユーザーIDとパスワードを入力してください');
                return;
            }

            const apiUrl = document.getElementById('sheetsUrl').value.trim();
            if (!apiUrl || !isAppsScriptUrl(apiUrl)) {
                showError(errorDiv, '先に接続設定でApps Script URLを設定してください');
                showSettings();
                return;
            }

            try {
                showSyncIndicator('認証中...', 'info');

                const result = await apiCall('authenticate', {
                    credentials: { username: username, password: password }
                });

                if (!result.success) {
                    showError(errorDiv, result.error || '認証に失敗しました');
                    showSyncIndicator('認証失敗', 'error');
                    return;
                }

                currentUser = result.user;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showSyncIndicator('認証成功', 'success');
                showMainScreen();

            } catch (error) {
                console.error('認証エラー:', error);
                showError(errorDiv, '認証中にエラーが発生しました: ' + error.message);
                showSyncIndicator('認証エラー', 'error');
            }
        }

        /**
         * メイン画面表示
         */
        function showMainScreen() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'block';
            
            document.getElementById('currentUserName').textContent = `${currentUser.name}（${currentUser.id}）`;
            document.getElementById('currentUserRole').textContent = currentUser.role === 'admin' ? '管理者' : '担当者';
            
            updateControlButtonsVisibility();
            loadData();
            loadSettings();
            setupAutoUpdate();
        }

        /**
         * ログアウト
         */
        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            
            if (autoUpdateTimer) { 
                clearInterval(autoUpdateTimer); 
                autoUpdateTimer = null; 
            }
            
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainScreen').style.display = 'none';
            
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            
            const errorDiv = document.getElementById('loginError');
            if (errorDiv) errorDiv.style.display = 'none';
            
            showSyncIndicator('ログアウトしました', 'success');
        }

        // ========================================
        // ユーティリティ関数（統合）
        // ========================================

        function parseAmount(value) {
            if (typeof value === 'number') return value;
            if (!value) return 0;
            return parseFloat(String(value).replace(/[¥,]/g, '')) || 0;
        }

        function formatTelForIPhone(phoneNumber) {
            return String(phoneNumber || '').replace(/[^\d+]/g, '');
        }

        function isIOS() {
            return /iPhone|iPad|iPod/i.test(navigator.userAgent);
        }

        function formatDateTime(isoString) {
            if (!isoString) return '';
            try {
                const date = new Date(isoString);
                if (isNaN(date.getTime())) return String(isoString);
                return date.toLocaleString('ja-JP', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return String(isoString) || '';
            }
        }

        function formatDateTimeMobile(isoString) {
            if (!isoString) return '-';
            try {
                const date = new Date(isoString);
                if (isNaN(date.getTime())) return String(isoString);
                
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const hour = date.getHours();
                const minute = date.getMinutes().toString().padStart(2, '0');
                
                return `${month}月${day}日 ${hour}:${minute}`;
            } catch (error) {
                return String(isoString) || '-';
            }
        }

        function formatDateMobile(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return String(dateString);
                
                const month = date.getMonth() + 1;
                const day = date.getDate();
                
                return `${month}月${day}日`;
            } catch (error) {
                return String(dateString) || '-';
            }
        }

        function calculateOverdueDays(dueDate) {
            if (!dueDate) return null;
            const due = new Date(dueDate);
            const today = new Date();
            due.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0);
            const diffTime = today - due;
            return Math.floor(diffTime / (1000 * 60 * 60 * 24));
        }

        function isZeroAmountRecord(record) {
            return parseAmount(record.amount) <= 0;
        }

        function showSyncIndicator(message, type = 'info') {
            const indicator = document.getElementById('syncIndicator');
            indicator.textContent = message;
            indicator.className = `sync-indicator ${type}`;
            indicator.style.display = 'block';
            setTimeout(() => { indicator.style.display = 'none'; }, 3000);
        }

        function isAppsScriptUrl(url) {
            return /https:\/\/script\.google\.com\/macros\/s\/.+\/exec/i.test(url);
        }

        function showError(element, message) {
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => { element.style.display = 'none'; }, 5000);
        }

        function requireAdminAccess(functionName) {
            if (!currentUser || currentUser.role !== 'admin') {
                alert(`${functionName}は管理者のみ利用できます`);
                return false;
            }
            return true;
        }

        function updateControlButtonsVisibility() {
            const isAdmin = (currentUser && currentUser.role === 'admin');
            const adminButtons = ['btnAddRecord', 'btnExportExcel', 'btnBulkDelete'];
            adminButtons.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button) button.style.display = isAdmin ? '' : 'none';
            });
        }

        // ========================================
        // データ管理（統合）
        // ========================================

        function buildSchoolLastEditMap() {
            schoolLastEditMap.clear();
            if (!allData || allData.length === 0) return;

            allData.forEach(r => {
                if (!r || !r.schoolName || !r.lastUpdated) return;
                const t = new Date(r.lastUpdated);
                if (isNaN(t.getTime())) return;

                const cur = schoolLastEditMap.get(r.schoolName);
                if (!cur || t > cur) {
                    schoolLastEditMap.set(r.schoolName, t);
                }
            });
        }

        function updateLastEditInfo() {
            const el = document.getElementById('lastEditInfo');
            if (!el) return;

            if (!allData || allData.length === 0) {
                el.textContent = '最終編集: データなし';
                return;
            }

            let latest = null;
            allData.forEach(r => {
                if (r && r.lastUpdated) {
                    const dt = new Date(r.lastUpdated);
                    if (!isNaN(dt.getTime())) {
                        if (!latest || dt > latest) latest = dt;
                    }
                }
            });

            if (!latest) {
                el.textContent = '最終編集: 不明';
                return;
            }

            const now = new Date();
            const diffMinutes = Math.floor((now - latest) / (1000 * 60));
            let displayText = `最終編集: ${formatDateTimeMobile(latest.toISOString())}`;
            if (diffMinutes < 60) {
                displayText += ` (${diffMinutes}分前)`;
            } else if (diffMinutes < 1440) {
                displayText += ` (${Math.floor(diffMinutes / 60)}時間前)`;
            } else {
                displayText += ` (${Math.floor(diffMinutes / 1440)}日前)`;
            }
            el.textContent = displayText;
        }

        function loadData() {
            const savedData = localStorage.getItem('jukuSystemData');
            if (savedData) {
                try { 
                    allData = JSON.parse(savedData); 
                } catch (error) { 
                    console.error('Data loading error:', error);
                    allData = []; 
                }
            } else {
                allData = [];
            }
            
            buildSchoolLastEditMap();
            populateAssignedToFilter();
            applyAllFilters();
            updateLastEditInfo();
        }

        // ========================================
        // Apps Script連携（統合版・HTTPメソッド自動切替）
        // ========================================

        async function syncFromSheets() {
            if (syncing) return;
            if (document.getElementById('editModal').style.display === 'block') {
                const status = document.getElementById('syncStatus');
                if (status) {
                    status.textContent = '編集中のため同期待機';
                    setTimeout(() => status.textContent = '', 3000);
                }
                return;
            }

            syncing = true;
            const status = document.getElementById('syncStatus');
            if (status) {
                status.innerHTML = '<span class="loading"></span> 同期中...';
            }

            try {
                // getData は自動的にGETリクエストで送信される
                const result = await apiCall('getData');

                allData = (result.data || []).map(item => ({
                    customerCode: item.customerCode || '',
                    schoolName: item.schoolName || '',
                    amount: parseAmount(item.amount || 0),
                    dueDate: item.dueDate || '',
                    paymentDate: item.paymentDate || '',
                    progress: item.progress || '未対応',
                    assignedTo: item.assignedTo || '',
                    phone: item.phone || '',
                    notes: item.notes || '',
                    lastUpdated: item.lastUpdated || '',
                    version: item.version || 1
                }));

                localStorage.setItem('jukuSystemData', JSON.stringify(allData));
                buildSchoolLastEditMap();
                populateAssignedToFilter();
                applyAllFilters();
                updateLastEditInfo();

                if (status) {
                    status.textContent = `✅ 同期完了 (${allData.length}件)`;
                    setTimeout(() => status.textContent = '', 3000);
                }
                showSyncIndicator(`同期完了 (${allData.length}件)`, 'success');

            } catch (error) {
                console.error('同期エラー:', error);
                if (status) {
                    status.textContent = '❌ 同期失敗: ' + error.message;
                    setTimeout(() => status.textContent = '', 5000);
                }
                showSyncIndicator('同期失敗: ' + error.message, 'error');
            } finally {
                syncing = false;
            }
        }

        async function sendUpdatesToServer(updates) {
            if (updates.length === 0) return true;

            try {
                // updateRecords は自動的にPOSTリクエストで送信される
                const result = await apiCall('updateRecords', { updates: updates });

                if (result.conflicts && result.conflicts.length > 0) {
                    alert('他のユーザーが更新しました。最新データを取得します。');
                    await syncFromSheets();
                    return false;
                }
                
                if (result.errors && result.errors.length > 0) {
                    alert('更新エラー: ' + result.errors[0].error);
                    return false;
                }

                if (result.success && result.success.length > 0) {
                    result.success.forEach(s => {
                        const rec = allData.find(r => r.customerCode === s.customerCode);
                        if (rec) {
                            rec.version = s.version;
                            if (s.lastUpdated) rec.lastUpdated = s.lastUpdated;
                        }
                    });
                    localStorage.setItem('jukuSystemData', JSON.stringify(allData));
                }

                showSyncIndicator('サーバーに同期完了', 'success');
                return true;

            } catch (error) {
                console.error('更新送信エラー:', error);
                throw error;
            }
        }

        // ========================================
        // フィルタリング・検索・ソート（統合版）
        // ========================================

        function applyAllFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            currentSearchTerm = searchTerm;
            let tempFiltered = [...allData];

            if (currentAssignedToFilter) {
                tempFiltered = tempFiltered.filter(row => 
                    (row.assignedTo || '') === currentAssignedToFilter
                );
            }

            if (searchTerm) {
                tempFiltered = tempFiltered.filter(row => 
                    (row.schoolName || '').toLowerCase().includes(searchTerm) ||
                    (row.assignedTo || '').toLowerCase().includes(searchTerm) ||
                    (row.phone || '').includes(searchTerm) ||
                    (row.notes || '').toLowerCase().includes(searchTerm)
                );
            }

            const nonZeroRecords = tempFiltered.filter(row => !isZeroAmountRecord(row));
            const zeroRecords = tempFiltered.filter(row => isZeroAmountRecord(row));
            filteredData = [...nonZeroRecords, ...zeroRecords];

            renderTable();
            updateStats();
            updateEmptyState();
        }

        function updateAssignedToFilter() {
            currentAssignedToFilter = document.getElementById('assignedToFilter').value;
            applyAllFilters();
        }

        function populateAssignedToFilter() {
            const select = document.getElementById('assignedToFilter');
            if (!select) return;
            const currentValue = select.value;
            const assignedPersons = new Set();
            
            allData.forEach(row => {
                const assignedTo = row.assignedTo;
                if (assignedTo) {
                    assignedPersons.add(assignedTo);
                }
            });

            select.innerHTML = '<option value="">担当者: 全て</option>';
            Array.from(assignedPersons).sort().forEach(person => {
                const option = document.createElement('option');
                option.value = person;
                option.textContent = person;
                select.appendChild(option);
            });

            select.value = currentValue;
        }

        function sortByDueDate(nearFirst = true, btn = null) {
            document.querySelectorAll('.control-buttons .btn').forEach(b => b.classList.remove('sort-active'));
            if (btn) btn.classList.add('sort-active');

            const nonZeroRecords = filteredData.filter(row => !isZeroAmountRecord(row));
            const zeroRecords = filteredData.filter(row => isZeroAmountRecord(row));

            const sortFn = (a, b) => {
                const dateA = a.dueDate ? new Date(a.dueDate) : new Date('2099-12-31');
                const dateB = b.dueDate ? new Date(b.dueDate) : new Date('2099-12-31');
                return nearFirst ? (dateA - dateB) : (dateB - dateA);
            };

            nonZeroRecords.sort(sortFn);
            zeroRecords.sort(sortFn);

            filteredData = [...nonZeroRecords, ...zeroRecords];
            renderTable();
            showTempMessage(nearFirst ? '📅 期日が近い順で表示中' : '📅 期日が遠い順で表示中');
        }

        function sortByLastUpdated(newestFirst = true, btn = null) {
            document.querySelectorAll('.control-buttons .btn').forEach(b => b.classList.remove('sort-active'));
            if (btn) btn.classList.add('sort-active');

            const nonZeroRecords = filteredData.filter(row => !isZeroAmountRecord(row));
            const zeroRecords = filteredData.filter(row => isZeroAmountRecord(row));

            const sortByRecordTime = (a, b) => {
                const dateA = a.lastUpdated ? new Date(a.lastUpdated) : new Date('1900-01-01');
                const dateB = b.lastUpdated ? new Date(b.lastUpdated) : new Date('1900-01-01');
                return newestFirst ? (dateB - dateA) : (dateA - dateB);
            };

            nonZeroRecords.sort(sortByRecordTime);
            zeroRecords.sort(sortByRecordTime);

            filteredData = [...nonZeroRecords, ...zeroRecords];
            renderTable();
            showTempMessage(newestFirst ? '🕒 更新が新しい順で表示中' : '🕒 更新が古い順で表示中');
        }

        function showTempMessage(message) {
            const firstStatCard = document.querySelector('.stat-value');
            if (firstStatCard) {
                const originalText = firstStatCard.textContent;
                firstStatCard.textContent = message;
                firstStatCard.style.fontSize = '16px';
                firstStatCard.style.color = '#28a745';
                
                setTimeout(() => {
                    firstStatCard.textContent = originalText;
                    firstStatCard.style.fontSize = '28px';
                    firstStatCard.style.color = '#007bff';
                }, 3000);
            }
        }

        function sortTable(columnIndex) {
            if (sortColumn === columnIndex) {
                sortDirection *= -1;
            } else {
                sortColumn = columnIndex;
                sortDirection = 1;
            }

            const sortKeys = ['schoolName', 'amount', 'dueDate', null, 'paymentDate', 'progress', 'assignedTo', 'phone', 'lastUpdated', 'notes'];
            const key = sortKeys[columnIndex];

            const nonZeroRecords = filteredData.filter(row => !isZeroAmountRecord(row));
            const zeroRecords = filteredData.filter(row => isZeroAmountRecord(row));

            const sortFunction = (a, b) => {
                let aVal, bVal;

                if (columnIndex === 1) {
                    aVal = parseAmount(a.amount) || 0;
                    bVal = parseAmount(b.amount) || 0;
                    return (aVal - bVal) * sortDirection;
                } else if (columnIndex === 2 || columnIndex === 4) {
                    aVal = new Date(a[key] || '1900-01-01');
                    bVal = new Date(b[key] || '1900-01-01');
                    return (aVal - bVal) * sortDirection;
                } else if (columnIndex === 3) {
                    const aOverdue = calculateOverdueDays(a.dueDate);
                    const bOverdue = calculateOverdueDays(b.dueDate);
                    
                    if (aOverdue === null && bOverdue === null) return 0;
                    if (aOverdue === null) return sortDirection;
                    if (bOverdue === null) return -sortDirection;
                    
                    return (aOverdue - bOverdue) * sortDirection;
                } else if (columnIndex === 8) {
                    aVal = a.lastUpdated ? new Date(a.lastUpdated) : new Date('1900-01-01');
                    bVal = b.lastUpdated ? new Date(b.lastUpdated) : new Date('1900-01-01');
                    return (aVal - bVal) * sortDirection;
                } else {
                    aVal = (a[key] || '').toString();
                    bVal = (b[key] || '').toString();
                    return aVal.localeCompare(bVal) * sortDirection;
                }
            };

            nonZeroRecords.sort(sortFunction);
            zeroRecords.sort(sortFunction);
            filteredData = [...nonZeroRecords, ...zeroRecords];
            renderTable();
        }

        // ========================================
        // UI表示（統合版）
        // ========================================

        function updateEmptyState() {
            const isEmpty = filteredData.length === 0;
            const emptyState = document.getElementById('emptyState');
            const tableContainer = document.querySelector('.table-container');
            const cardContainer = document.getElementById('cardContainer');
            
            if (isEmpty) {
                emptyState.style.display = 'block';
                tableContainer.style.display = 'none';
                cardContainer.style.display = 'none';
            } else {
                emptyState.style.display = 'none';
                if (window.innerWidth <= 768) {
                    tableContainer.style.display = 'none';
                    cardContainer.style.display = 'block';
                } else {
                    tableContainer.style.display = 'block';
                    cardContainer.style.display = 'none';
                }
            }
        }

        function renderTable() {
            renderTableView();
            renderCardView();
        }

        function renderTableView() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            filteredData.forEach((row, index) => {
                const tr = document.createElement('tr');
                const overdueDays = calculateOverdueDays(row.dueDate);
                const isZeroAmount = isZeroAmountRecord(row);

                if (isZeroAmount) {
                    tr.classList.add('completed-gray-row');
                } else if (overdueDays >= 10) {
                    tr.classList.add('overdue-pink-row');
                }

                // セル作成ヘルパー
                const createCell = (content, className = '') => {
                    const td = document.createElement('td');
                    if (typeof content === 'string') {
                        td.textContent = content;
                    } else {
                        td.appendChild(content);
                    }
                    if (className) td.className = className;
                    return td;
                };

                tr.appendChild(createCell(row.schoolName || ''));
                tr.appendChild(createCell('¥' + (parseAmount(row.amount) || 0).toLocaleString(), 'amount-display'));
                tr.appendChild(createCell(isZeroAmount ? '-' : (row.dueDate || '')));

                // 超過日数セル
                const overdueCell = document.createElement('td');
                if (isZeroAmount || overdueDays === null || overdueDays <= 0) {
                    overdueCell.textContent = '-';
                } else {
                    overdueCell.textContent = `${overdueDays}日`;
                    if (overdueDays >= 3) overdueCell.classList.add('overdue-red');
                }
                tr.appendChild(overdueCell);

                tr.appendChild(createCell(row.paymentDate || '-'));
                tr.appendChild(createCell(row.progress || ''));
                tr.appendChild(createCell(row.assignedTo || ''));

                // 電話番号セル
                const phoneCell = document.createElement('td');
                const phoneDiv = document.createElement('div');
                phoneDiv.className = 'phone-contact';
                
                if (isIOS() && currentUser && currentUser.role === 'staff' && row.phone) {
                    const phoneLink = document.createElement('a');
                    phoneLink.href = 'tel:' + formatTelForIPhone(row.phone);
                    phoneLink.className = 'phone-number';
                    phoneLink.textContent = row.phone;
                    phoneLink.style.color = '#007bff';
                    phoneLink.style.textDecoration = 'underline';
                    phoneDiv.appendChild(phoneLink);

                    const phoneBtn = document.createElement('a');
                    phoneBtn.href = 'tel:' + formatTelForIPhone(row.phone);
                    phoneBtn.className = 'action-btn phone-btn';
                    phoneBtn.textContent = '📞';
                    phoneDiv.appendChild(phoneBtn);
                } else {
                    const phoneSpan = document.createElement('span');
                    phoneSpan.className = 'phone-number';
                    phoneSpan.textContent = row.phone || '-';
                    phoneDiv.appendChild(phoneSpan);
                }
                phoneCell.appendChild(phoneDiv);
                tr.appendChild(phoneCell);

                // 最終更新セル
                const lastUpdatedCell = createCell(row.lastUpdated ? formatDateTime(row.lastUpdated) : '-');
                lastUpdatedCell.style.fontSize = '0.85em';
                lastUpdatedCell.style.color = '#666';
                lastUpdatedCell.style.whiteSpace = 'nowrap';
                tr.appendChild(lastUpdatedCell);

                tr.appendChild(createCell(row.notes || ''));

                // アクションセル
                const actionsCell = document.createElement('td');
                
                const editBtn = document.createElement('button');
                editBtn.className = 'action-btn edit-btn';
                editBtn.textContent = '編集';
                editBtn.addEventListener('click', () => editRecord(index));
                actionsCell.appendChild(editBtn);

                if (currentUser && currentUser.role === 'admin') {
                    const delBtn = document.createElement('button');
                    delBtn.className = 'action-btn delete-btn';
                    delBtn.textContent = '削除';
                    delBtn.addEventListener('click', () => deleteRecord(index));
                    actionsCell.appendChild(delBtn);
                }

                const histBtn = document.createElement('button');
                histBtn.className = 'action-btn history-btn';
                histBtn.textContent = '履歴';
                histBtn.addEventListener('click', () => showHistory(row.schoolName, row.customerCode));
                actionsCell.appendChild(histBtn);

                tr.appendChild(actionsCell);
                tbody.appendChild(tr);
            });
        }

        function renderCardView() {
            const container = document.getElementById('cardContainer');
            container.innerHTML = '';

            filteredData.forEach((row, index) => {
                const overdueDays = calculateOverdueDays(row.dueDate);
                const isZeroAmount = isZeroAmountRecord(row);
                
                const card = document.createElement('div');
                card.className = 'juku-card';
                
                if (isZeroAmount) {
                    card.classList.add('completed-gray');
                } else if (overdueDays >= 10) {
                    card.classList.add('overdue-pink');
                }

                // カードヘッダー
                const header = document.createElement('div');
                header.className = 'card-header';
                
                const schoolName = document.createElement('div');
                schoolName.className = 'card-school-name';
                schoolName.textContent = row.schoolName || '';
                
                const amount = document.createElement('div');
                amount.className = 'card-amount';
                amount.textContent = '¥' + (parseAmount(row.amount) || 0).toLocaleString();
                
                header.appendChild(schoolName);
                header.appendChild(amount);

                // 情報行作成ヘルパー
                const createInfoRow = (label, value, extra = null) => {
                    const row = document.createElement('div');
                    row.className = 'card-info-row';
                    
                    const labelEl = document.createElement('span');
                    labelEl.className = 'card-info-label';
                    labelEl.textContent = label;
                    
                    const valueEl = document.createElement('span');
                    if (typeof value === 'string') {
                        valueEl.textContent = value;
                    } else {
                        valueEl.appendChild(value);
                    }
                    
                    row.appendChild(labelEl);
                    row.appendChild(valueEl);
                    if (extra) row.appendChild(extra);
                    
                    return row;
                };

                // 期日行
                const dueDateValue = isZeroAmount ? '-' : (row.dueDate || '未設定');
                const overdueSpan = document.createElement('span');
                overdueSpan.className = 'card-overdue';
                
                if (isZeroAmount || overdueDays === null || overdueDays <= 0) {
                    overdueSpan.textContent = '-';
                    overdueSpan.classList.add('normal');
                } else if (overdueDays >= 3) {
                    overdueSpan.textContent = `${overdueDays}日`;
                    overdueSpan.classList.add('danger');
                } else {
                    overdueSpan.textContent = `${overdueDays}日`;
                    overdueSpan.classList.add('warning');
                }
                
                const dueDateRow = createInfoRow('期日:', dueDateValue, overdueSpan);

                // 担当・進捗行
                const assignValue = row.assignedTo || '';
                const progressValue = `進捗: ${row.progress || ''}`;
                const assignRow = createInfoRow('担当:', assignValue);
                const progressEl = document.createElement('span');
                progressEl.textContent = progressValue;
                assignRow.appendChild(progressEl);

                // 電話行
                const phoneValue = document.createElement('span');
                if (isIOS() && currentUser && currentUser.role === 'staff' && row.phone) {
                    const phoneLink = document.createElement('a');
                    phoneLink.href = 'tel:' + formatTelForIPhone(row.phone);
                    phoneLink.className = 'phone-number';
                    phoneLink.textContent = row.phone;
                    phoneLink.style.color = '#007bff';
                    phoneLink.style.textDecoration = 'underline';
                    phoneValue.appendChild(phoneLink);
                } else {
                    phoneValue.className = 'phone-number';
                    phoneValue.textContent = row.phone || '未登録';
                }
                const phoneRow = createInfoRow('電話:', phoneValue);

                const paymentRow = createInfoRow('入金予定:', row.paymentDate || '未設定');

                const updateValue = row.lastUpdated ? formatDateTimeMobile(row.lastUpdated) : '-';
                const updateRow = createInfoRow('最終更新:', updateValue);
                updateRow.querySelector('span:last-child').style.fontSize = '0.85em';
                updateRow.querySelector('span:last-child').style.color = '#666';

                // 備考行（条件付き）
                let notesRow = null;
                if (row.notes) {
                    const notesText = row.notes.length > 30 ? row.notes.substring(0, 30) + '...' : row.notes;
                    notesRow = createInfoRow('備考:', notesText);
                }

                // アクション
                const actions = document.createElement('div');
                actions.className = 'card-actions';

                if (isIOS() && currentUser && currentUser.role === 'staff') {
                    const phoneBtn = document.createElement('a');
                    phoneBtn.className = 'card-action-btn card-phone-btn';
                    
                    if (row.phone) {
                        phoneBtn.href = 'tel:' + formatTelForIPhone(row.phone);
                        phoneBtn.textContent = '📞 発信';
                    } else {
                        phoneBtn.textContent = '📞 未登録';
                        phoneBtn.style.opacity = '0.6';
                        phoneBtn.style.pointerEvents = 'none';
                    }
                    actions.appendChild(phoneBtn);
                }

                const editBtn = document.createElement('button');
                editBtn.className = 'card-action-btn card-edit-btn';
                editBtn.textContent = '✏️ 編集';
                editBtn.addEventListener('click', () => editRecord(index));
                actions.appendChild(editBtn);

                const histBtn = document.createElement('button');
                histBtn.className = 'card-action-btn card-history-btn';
                histBtn.textContent = '📋 履歴';
                histBtn.addEventListener('click', () => showHistory(row.schoolName, row.customerCode));
                actions.appendChild(histBtn);

                // カード組み立て
                card.appendChild(header);
                card.appendChild(dueDateRow);
                card.appendChild(assignRow);
                card.appendChild(phoneRow);
                card.appendChild(paymentRow);
                card.appendChild(updateRow);
                if (notesRow) card.appendChild(notesRow);
                card.appendChild(actions);

                container.appendChild(card);
            });
        }

        function updateStats() {
            const now = new Date();
            const activeData = filteredData.filter(row => !isZeroAmountRecord(row));
            
            const total = activeData.length;
            const totalAmount = activeData.reduce((sum, row) => sum + (parseAmount(row.amount) || 0), 0);
            const overdue = activeData.filter(row => row.dueDate && new Date(row.dueDate) < now).length;
            const dueSoon = activeData.filter(row => {
                if (!row.dueDate) return false;
                const diff = (new Date(row.dueDate) - now) / (1000 * 60 * 60 * 24);
                return diff >= 0 && diff <= 7;
            }).length;

            document.getElementById('totalRecords').textContent = total;
            document.getElementById('totalAmount').textContent = `¥${totalAmount.toLocaleString()}`;
            document.getElementById('overdueCount').textContent = overdue;
            document.getElementById('dueSoonCount').textContent = dueSoon;
        }

        // ========================================
        // 編集・追加・削除機能（統合版）
        // ========================================

        function showAddModal() {
            if (!requireAdminAccess('新規追加')) return;
            editingIndex = -1;
            document.getElementById('modalTitle').textContent = '新規追加';
            document.getElementById('editForm').reset();
            document.getElementById('editProgress').value = '未対応';
            setFieldPermissions();
            document.getElementById('editModal').style.display = 'block';
        }

        function editRecord(index) {
            editingIndex = index;
            const record = filteredData[index];
            
            document.getElementById('modalTitle').textContent = '編集';
            document.getElementById('editSchoolName').value = record.schoolName || '';
            document.getElementById('editAmount').value = (record.amount || '').toString();
            document.getElementById('editDueDate').value = record.dueDate || '';
            document.getElementById('editPaymentDate').value = record.paymentDate || '';
            document.getElementById('editProgress').value = record.progress || '未対応';
            document.getElementById('editAssignedTo').value = record.assignedTo || '';
            document.getElementById('editPhone').value = record.phone || '';
            document.getElementById('editNotes').value = record.notes || '';
            
            setFieldPermissions();
            document.getElementById('editModal').style.display = 'block';
        }

        function setFieldPermissions() {
            const baseFields = ['editSchoolName', 'editAmount', 'editDueDate', 'editAssignedTo', 'editPhone'];
            
            if (currentUser && currentUser.role === 'staff') {
                baseFields.forEach(id => {
                    const field = document.getElementById(id);
                    if (field) field.disabled = true;
                });
                ['editPaymentDate', 'editProgress', 'editNotes'].forEach(id => {
                    const field = document.getElementById(id);
                    if (field) field.disabled = false;
                });
            } else {
                [...baseFields, 'editPaymentDate', 'editProgress', 'editNotes'].forEach(id => {
                    const field = document.getElementById(id);
                    if (field) field.disabled = false;
                });
            }
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        async function deleteRecord(index) {
            if (!currentUser || currentUser.role !== 'admin') { 
                alert('削除権限がありません'); 
                return; 
            }
            
            const record = filteredData[index];
            if (!confirm(`${record.schoolName} のデータを削除しますか？`)) return;

            try {
                // deleteRecord は自動的にPOSTリクエストで送信される
                await apiCall('deleteRecord', { customerCode: record.customerCode });
                
                showSyncIndicator('サーバーから削除完了', 'success');
                await syncFromSheets();

            } catch (error) {
                console.error('削除エラー:', error);
                alert('削除に失敗しました: ' + error.message);
            }
        }

        async function bulkDeleteCompleted() {
            if (!requireAdminAccess('0円案件一括削除')) return;
            
            const targets = allData.filter(r => isZeroAmountRecord(r));
            if (targets.length === 0) { 
                alert('削除対象（0円案件）がありません'); 
                return; 
            }

            const firstConfirm = confirm(
                `0円案件 ${targets.length}件を完全削除しますか？\n\n` +
                `⚠️ タスク完了による完全削除です。レコード本体と関連する全履歴を削除します。`
            );
            if (!firstConfirm) return;
            
            const finalConfirm = confirm('本当に実行しますか？この操作は元に戻せません。');
            if (!finalConfirm) return;

            try {
                showSyncIndicator('0円案件を完全削除中...', 'info');
                
                // bulkDeleteCompleted は自動的にPOSTリクエストで送信される
                const result = await apiCall('bulkDeleteCompleted');
                
                showSyncIndicator(`完全削除完了: ${result.deletedCount}件`, 'success');
                alert(`完全削除が完了しました（${result.deletedCount}件）`);
                await syncFromSheets();

            } catch (error) {
                console.error('0円案件削除エラー:', error);
                showSyncIndicator('削除失敗: ' + error.message, 'error');
                alert('削除に失敗しました: ' + error.message);
            }
        }

        // ========================================
        // 履歴機能（統合版・HTTPメソッド自動切替対応）
        // ========================================

        async function showHistory(schoolName, customerCode = '') {
            currentHistorySchool = schoolName;
            
            try {
                showSyncIndicator('履歴を取得中...', 'info');
                
                // getHistory は自動的にGETリクエストで送信される
                const result = await apiCall('getHistory', { 
                    customerCode: customerCode, 
                    schoolName: schoolName 
                });
                
                editHistory = result.history || [];
                showSyncIndicator(`履歴取得完了 (${editHistory.length}件)`, 'success');
                
            } catch (error) {
                console.error('履歴取得エラー:', error);
                showSyncIndicator('履歴取得に失敗しました', 'error');
                editHistory = [];
            }
            
            renderHistoryTable();
            document.getElementById('historyModal').style.display = 'block';
        }

        function renderHistoryTable() {
            const schoolHistory = editHistory.filter(h => h.schoolName === currentHistorySchool);
            const tbody = document.getElementById('historyTableBody');
            const mobileContainer = document.getElementById('mobileHistoryContainer');
            
            tbody.innerHTML = '';
            mobileContainer.innerHTML = '';
            
            const sortedHistory = [...schoolHistory].sort((a, b) => {
                const dateA = new Date(a.editDate);
                const dateB = new Date(b.editDate);
                return historyNewestFirst ? dateB - dateA : dateA - dateB;
            });
            
            // デスクトップ表示
            sortedHistory.forEach(entry => {
                const tr = document.createElement('tr');
                
                [
                    formatDateTime(entry.editDate),
                    entry.editedBy || entry.editor || '',
                    entry.field,
                    entry.oldValue,
                    entry.newValue
                ].forEach(text => {
                    const td = document.createElement('td');
                    td.textContent = text;
                    tr.appendChild(td);
                });
                
                tbody.appendChild(tr);
            });

            // モバイル表示
            sortedHistory.forEach(entry => {
                const item = document.createElement('div');
                item.className = 'mobile-history-item';
                
                const header = document.createElement('div');
                header.className = 'mobile-history-header';
                
                const dateDiv = document.createElement('div');
                dateDiv.className = 'mobile-history-date';
                dateDiv.textContent = formatDateTimeMobile(entry.editDate);
                
                const editorDiv = document.createElement('div');
                editorDiv.className = 'mobile-history-editor';
                editorDiv.textContent = entry.editedBy || entry.editor || '';
                
                header.appendChild(dateDiv);
                header.appendChild(editorDiv);
                
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'mobile-history-field';
                fieldDiv.textContent = entry.field;
                
                const changeDiv = document.createElement('div');
                changeDiv.className = 'mobile-history-change';
                
                const oldSpan = document.createElement('span');
                oldSpan.className = 'mobile-history-old';
                
                const newSpan = document.createElement('span');
                newSpan.className = 'mobile-history-new';
                
                const arrowSpan = document.createElement('span');
                arrowSpan.className = 'mobile-history-arrow';
                arrowSpan.textContent = '→';
                
                if (entry.field === '入金予定日' || entry.field === '期日') {
                    oldSpan.textContent = entry.oldValue ? formatDateMobile(entry.oldValue) : '-';
                    newSpan.textContent = entry.newValue ? formatDateMobile(entry.newValue) : '-';
                } else {
                    oldSpan.textContent = entry.oldValue || '-';
                    newSpan.textContent = entry.newValue || '-';
                }
                
                changeDiv.appendChild(oldSpan);
                changeDiv.appendChild(arrowSpan);
                changeDiv.appendChild(newSpan);
                
                item.appendChild(header);
                item.appendChild(fieldDiv);
                item.appendChild(changeDiv);
                
                mobileContainer.appendChild(item);
            });
            
            const btn = document.getElementById('historySortBtn');
            btn.textContent = historyNewestFirst ? '🔄 新しい順' : '🔄 古い順';
        }

        function toggleHistorySort() {
            historyNewestFirst = !historyNewestFirst;
            renderHistoryTable();
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
        }

        // ========================================
        // 設定・その他（統合版）
        // ========================================

        function showSettings() {
            document.getElementById('settingsPanel').style.display = 'block';
        }

        function hideSettings() {
            document.getElementById('settingsPanel').style.display = 'none';
        }

        function saveSettings() {
            const rawUrl = document.getElementById('sheetsUrl').value.trim();
            
            if (!isAppsScriptUrl(rawUrl)) {
                alert('Apps ScriptのWebアプリURLを入力してください');
                return;
            }
            
            const settings = {
                sheetsUrl: rawUrl,
                autoUpdateInterval: document.getElementById('autoUpdateInterval').value
            };
            
            localStorage.setItem('appSettings', JSON.stringify(settings));
            setupAutoUpdate();
            
            alert('設定を保存しました（v3.1完全統合版対応）');
        }

        function loadSettings() {
            const settings = localStorage.getItem('appSettings');
            if (settings) {
                try {
                    const parsed = JSON.parse(settings);
                    document.getElementById('sheetsUrl').value = parsed.sheetsUrl || '';
                    document.getElementById('autoUpdateInterval').value = parsed.autoUpdateInterval || '30000';
                } catch (e) {
                    console.error('設定の読み込みに失敗:', e);
                }
            }
        }

        function setupAutoUpdate() {
            if (autoUpdateTimer) { 
                clearInterval(autoUpdateTimer); 
                autoUpdateTimer = null; 
            }
            
            const interval = parseInt(document.getElementById('autoUpdateInterval').value);
            if (interval > 0) {
                autoUpdateTimer = setInterval(() => {
                    const url = document.getElementById('sheetsUrl').value.trim();
                    if (url) syncFromSheets();
                }, interval);
                showSyncIndicator(`自動同期開始 (${interval/1000}秒間隔)`, 'info');
            }
        }

        function refreshData() {
            syncFromSheets();
        }

        function resetLocalData() {
            const firstConfirm = confirm(
                '全てのローカルデータを削除しますか？\n\n' +
                '削除される内容：\n' +
                '• 表示中の塾管理データ\n' +
                '• システム内で編集した進捗・入金予定日・備考\n' +
                '• 編集履歴\n' +
                '• 接続設定\n\n' +
                'Apps Scriptのデータには影響しません。'
            );
            if (!firstConfirm) return;
            
            const finalConfirm = confirm(
                '本当に削除しますか？\n\n' +
                '⚠️ 重要な警告：\n' +
                'システム内で編集した内容は完全に失われます。\n' +
                'この操作は元に戻せません。'
            );
            if (!finalConfirm) return;
            
            try {
                ['jukuSystemData', 'editHistory', 'appSettings', 'currentUser'].forEach(key => {
                    localStorage.removeItem(key);
                });
                
                allData = [];
                editHistory = [];
                schoolLastEditMap.clear();
                currentAssignedToFilter = '';
                
                if (autoUpdateTimer) { 
                    clearInterval(autoUpdateTimer); 
                    autoUpdateTimer = null; 
                }
                
                populateAssignedToFilter();
                applyAllFilters();
                updateEmptyState();
                updateLastEditInfo();
                showSyncIndicator('ローカルデータを完全にリセットしました', 'success');
            } catch (error) {
                console.error('Reset error:', error);
                showSyncIndicator('リセット中にエラーが発生しました', 'error');
            }
        }

        function exportToExcel() {
            if (!requireAdminAccess('Excelエクスポート')) return;
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(allData.map(row => ({
                '得意先コード': row.customerCode || '',
                '請求先名': row.schoolName,
                '未収金額': parseAmount(row.amount),
                '期日': row.dueDate,
                '入金予定日': row.paymentDate || '',
                '進捗': row.progress,
                '担当': row.assignedTo,
                '電話番号': row.phone || '',
                '最終更新': row.lastUpdated || '',
                '備考': row.notes || '',
                'バージョン': row.version || 1
            })));
            
            XLSX.utils.book_append_sheet(wb, ws, 'データ');
            XLSX.writeFile(wb, 'juku_data_v31_complete_integration.xlsx');
        }

        // ========================================
        // フォーム処理・イベントリスナー
        // ========================================

        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                schoolName: document.getElementById('editSchoolName').value,
                amount: parseAmount(document.getElementById('editAmount').value),
                dueDate: document.getElementById('editDueDate').value,
                paymentDate: document.getElementById('editPaymentDate').value,
                progress: document.getElementById('editProgress').value,
                assignedTo: document.getElementById('editAssignedTo').value,
                phone: document.getElementById('editPhone').value,
                notes: document.getElementById('editNotes').value
            };

            try {
                if (editingIndex === -1) {
                    // 新規追加 - addRecord は自動的にPOSTリクエストで送信される
                    if (currentUser.role !== 'admin') { 
                        alert('新規追加は管理者のみ可能です'); 
                        return; 
                    }
                    
                    await apiCall('addRecord', { record: formData });
                    showSyncIndicator('新規追加完了', 'success');
                    await syncFromSheets();
                } else {
                    // 更新
                    const originalIndex = allData.indexOf(filteredData[editingIndex]);
                    const oldData = allData[originalIndex];
                    
                    formData.customerCode = oldData.customerCode || '';
                    formData.version = oldData.version || 1;

                    if (currentUser.role === 'staff') {
                        const allowed = ['paymentDate', 'progress', 'notes'];
                        Object.keys(formData).forEach(key => {
                            if (!allowed.includes(key) && key !== 'version' && key !== 'customerCode') {
                                formData[key] = oldData[key];
                            }
                        });
                    }

                    const updateSuccess = await sendUpdatesToServer([formData]);
                    if (!updateSuccess) { 
                        closeModal(); 
                        return; 
                    }
                    await syncFromSheets();
                }
                closeModal();
            } catch (error) {
                console.error('保存エラー:', error);
                alert('データ保存に失敗しました: ' + error.message);
            }
        });

        // モーダル外クリックで閉じる
        window.onclick = function(event) {
            const editModal = document.getElementById('editModal');
            const historyModal = document.getElementById('historyModal');
            if (event.target === editModal) closeModal();
            if (event.target === historyModal) closeHistoryModal();
        }

        // リサイズ時の表示切り替え
        window.addEventListener('resize', function() { 
            updateEmptyState(); 
        });

        // オンライン復帰時の自動同期
        window.addEventListener('online', () => {
            const url = document.getElementById('sheetsUrl').value.trim();
            if (url) {
                console.log('オンライン復帰 - 自動同期実行');
                syncFromSheets();
            }
        });

        // ========================================
        // 初期化処理
        // ========================================

        document.addEventListener('DOMContentLoaded', function() {
            // Enterキーでログイン
            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
            
            // 自動ログイン
            try {
                const savedUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
                if (savedUser && savedUser.id && savedUser.name) {
                    currentUser = savedUser;
                    showMainScreen();
                }
            } catch (error) {
                console.log('Auto-login failed:', error);
            }
        });
    </script>
</body>
</html>
