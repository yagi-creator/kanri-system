<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="å¡¾å…¥é‡‘ç®¡ç†">
    <title>å¡¾å…¥é‡‘ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v2.9 å®Œæˆç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            -webkit-user-select: none;
            user-select: none;
        }

        input, textarea, .phone-number {
            -webkit-user-select: text;
            user-select: text;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }

        .login-box h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .btn {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            -webkit-tap-highlight-color: transparent;
        }

        .btn:hover {
            background: #0056b3;
        }

        .btn-primary { background: #007bff; }
        .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-info { background: #17a2b8; }
        .btn-secondary { background: #6c757d; }

        .login-btn {
            width: 100%;
            background: #007bff;
            color: white;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            min-height: 44px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            min-height: 32px;
        }

        .btn-outline-primary {
            color: #007bff;
            border: 1px solid #007bff;
            background: transparent;
        }

        .btn-outline-primary:hover {
            background: #007bff;
            color: white;
        }

        .sort-active {
            background: #007bff !important;
            color: white !important;
            font-weight: bold;
        }

        .main-content {
            display: none;
        }

        .header {
            background: #007bff;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            margin: 0;
        }

        .user-info {
            text-align: right;
        }

        .user-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            align-items: center;
        }

        .header-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            min-height: 44px;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .header-btn.btn-danger-header {
            background: rgba(220, 53, 69, 0.8);
        }

        .header-btn.btn-danger-header:hover {
            background: rgba(220, 53, 69, 1);
        }

        .settings-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: none;
        }

        .settings-panel h3 {
            margin-bottom: 15px;
            color: #007bff;
        }

        .settings-row {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .settings-row label {
            width: 150px;
            font-weight: bold;
        }

        .settings-row input, .settings-row select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .controls h3 {
            margin-bottom: 15px;
            color: #007bff;
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .table-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid #dee2e6;
            cursor: pointer;
        }

        th:hover {
            background: #e9ecef;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .overdue-red {
            color: #dc3545;
            font-weight: bold;
        }

        .overdue-pink-row {
            background-color: #ffe6ea !important;
        }

        .overdue-pink-row:hover {
            background-color: #ffd6e0 !important;
        }

        .overdue-pink-row .overdue-red {
            color: #a71e2a;
            font-weight: bold;
        }

        .completed-gray-row {
            background: #d6d8db !important;
            color: #5a5c5f;
        }

        .completed-gray-row:hover {
            background: #c8cacd !important;
        }

        .amount-display {
            font-size: 1.2em;
            font-weight: bold;
            color: #007bff;
        }

        .phone-contact {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .phone-contact .phone-number {
            font-family: monospace;
            font-weight: bold;
        }

        .search-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .search-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close:hover {
            color: #000;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .action-btn {
            padding: 8px 12px;
            margin: 2px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            min-height: 44px;
            min-width: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
            text-decoration: none;
        }

        .phone-btn {
            background: #28a745;
            color: white;
            font-size: 16px;
        }

        .phone-btn:active {
            transform: scale(0.95);
        }

        .phone-btn:disabled {
            background: #6c757d;
            opacity: 0.5;
            cursor: not-allowed;
        }

        .edit-btn {
            background: #ffc107;
            color: #212529;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
        }

        .history-btn {
            background: #17a2b8;
            color: white;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .error-message {
            color: #dc3545;
            margin-top: 10px;
            font-size: 14px;
        }

        .success-message {
            color: #28a745;
            margin-top: 10px;
            font-size: 14px;
        }

        .card-container {
            display: none;
        }

        .juku-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
        }

        .juku-card.overdue-pink {
            background-color: #ffe6ea;
            border-left-color: #dc3545;
        }

        .juku-card.completed-gray {
            background: #d6d8db;
            border-left-color: #5a5c5f;
            color: #5a5c5f;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .card-school-name {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
        }

        .card-amount {
            font-size: 1.3em;
            font-weight: bold;
            color: #007bff;
        }

        .card-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .card-info-label {
            font-weight: bold;
            color: #666;
            min-width: 80px;
        }

        .card-overdue {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .card-overdue.normal {
            background: #e3f2fd;
            color: #1976d2;
        }

        .card-overdue.warning {
            background: #fff3e0;
            color: #f57c00;
        }

        .card-overdue.danger {
            background: #ffebee;
            color: #d32f2f;
        }

        .card-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .card-action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            min-height: 44px;
            -webkit-tap-highlight-color: transparent;
            text-decoration: none;
        }

        .card-phone-btn {
            background: #28a745;
            color: white;
        }

        .card-phone-btn:disabled {
            background: #6c757d;
            opacity: 0.5;
        }

        .card-edit-btn {
            background: #ffc107;
            color: #212529;
        }

        .card-history-btn {
            background: #17a2b8;
            color: white;
        }

        .empty-state {
            background: white;
            padding: 60px 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .empty-state h3 {
            color: #666;
            margin-bottom: 15px;
        }

        .empty-state p {
            color: #999;
            margin-bottom: 20px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .history-table th {
            background: #f8f9fa;
            padding: 10px;
            text-align: left;
            font-size: 12px;
        }

        .history-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #dee2e6;
            font-size: 12px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 123, 255, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 999;
            display: none;
        }

        .sync-indicator.success {
            background: rgba(40, 167, 69, 0.9);
        }

        .sync-indicator.error {
            background: rgba(220, 53, 69, 0.9);
        }

        .version-info {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 2px;
        }

        .feature-badge {
            background: #28a745;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 8px;
            margin-left: 8px;
            font-weight: bold;
        }

        /* ãƒ¢ãƒã‚¤ãƒ«å±¥æ­´è¡¨ç¤ºã®æœ€é©åŒ– */
        .mobile-history {
            display: none;
        }

        .mobile-history-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #007bff;
        }

        .mobile-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .mobile-history-date {
            font-weight: bold;
            color: #007bff;
            font-size: 0.9em;
        }

        .mobile-history-editor {
            font-size: 0.8em;
            color: #666;
        }

        .mobile-history-field {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .mobile-history-change {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
        }

        .mobile-history-old {
            color: #dc3545;
            text-decoration: line-through;
        }

        .mobile-history-new {
            color: #28a745;
            font-weight: bold;
        }

        .mobile-history-arrow {
            color: #666;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                flex-direction: column;
                text-align: center;
            }

            .user-info {
                margin-top: 15px;
            }

            .user-actions {
                flex-direction: column;
                gap: 5px;
            }

            .header-btn {
                width: 150px;
            }
            
            .control-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 5px;
                min-height: 44px;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px 4px;
            }

            .table-container {
                display: none;
            }
            
            .card-container {
                display: block;
            }

            /* ãƒ¢ãƒã‚¤ãƒ«å±¥æ­´è¡¨ç¤º */
            .history-table {
                display: none;
            }

            .mobile-history {
                display: block;
            }

            .modal-content {
                margin: 2% auto;
                width: 95%;
                max-height: 90vh;
            }
        }

        @media (min-width: 769px) {
            .phone-contact {
                justify-content: flex-start;
            }
            
            .action-btn {
                margin: 2px;
                min-width: 60px;
            }
        }
    </style>
</head>
<body>
    <div id="syncIndicator" class="sync-indicator"></div>

    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h2>å¡¾å…¥é‡‘ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v2.9 å®Œæˆç‰ˆ</h2>
            <div class="form-group">
                <label for="username">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</label>
                <input type="text" id="username" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›">
            </div>
            <div class="form-group">
                <label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
            </div>
            <button class="login-btn" onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <div id="loginError" class="error-message" style="display: none;"></div>
        </div>
    </div>

    <div id="mainScreen" class="main-content">
        <div class="container">
            <div class="header">
                <div>
                    <h1>å¡¾å…¥é‡‘ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v2.9 <span class="feature-badge">å®Œæˆç‰ˆ</span></h1>
                    <div class="version-info">å¡¾åˆ¥ç·¨é›†å±¥æ­´ãƒ»æœ€çµ‚æ›´æ–°è¡¨ç¤ºæœ€é©åŒ–ç‰ˆ</div>
                    <div id="lastEditInfo" style="font-size: 13px; opacity: 0.9; margin-top: 4px;">æœ€çµ‚ç·¨é›†: -</div>
                </div>
                <div class="user-info">
                    <div id="currentUserName" style="font-weight: bold; font-size: 16px;"></div>
                    <div id="currentUserRole" style="font-size: 14px;"></div>
                    <div class="user-actions">
                        <button class="header-btn btn-danger-header" onclick="resetLocalData()" id="btnResetLocal">ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
                        <button class="header-btn" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                    </div>
                </div>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalRecords">0</div>
                    <div class="stat-label">æœ‰åŠ¹ãƒ‡ãƒ¼ã‚¿æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalAmount">Â¥0</div>
                    <div class="stat-label">ç·æœªåé‡‘é¡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="overdueCount">0</div>
                    <div class="stat-label">æœŸé™è¶…é</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="dueSoonCount">0</div>
                    <div class="stat-label">æœŸé™é–“è¿‘</div>
                </div>
            </div>

            <div id="settingsPanel" class="settings-panel">
                <h3>Google é€£æºè¨­å®š <span class="feature-badge">å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œ</span></h3>
                <div class="settings-row">
                    <label>æ¥ç¶šURL:</label>
                    <input type="text" id="sheetsUrl" placeholder="Apps Script Webã‚¢ãƒ—ãƒªURL">
                </div>
                <div class="settings-row">
                    <label>è‡ªå‹•æ›´æ–°é–“éš”:</label>
                    <select id="autoUpdateInterval">
                        <option value="0">æ‰‹å‹•ã®ã¿</option>
                        <option value="30000" selected>30ç§’</option>
                        <option value="60000">1åˆ†</option>
                        <option value="300000">5åˆ†</option>
                    </select>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-info" onclick="syncFromSheets()">ä»Šã™ãåŒæœŸ</button>
                    <button class="btn btn-success" onclick="saveSettings()">è¨­å®šä¿å­˜</button>
                    <button class="btn btn-secondary" onclick="hideSettings()">é–‰ã˜ã‚‹</button>
                    <span id="syncStatus" style="margin-left: 10px;"></span>
                </div>
                <div style="margin-top: 8px; font-size: 12px; color: #666;">
                    Apps Scriptã®Webã‚¢ãƒ—ãƒªURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆå…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ©ç”¨å¯èƒ½ï¼‰
                </div>
            </div>

            <div class="controls">
                <h3>æ“ä½œãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
                <div class="control-buttons">
                    <button class="btn btn-primary" onclick="showAddModal()" id="btnAddRecord">æ–°è¦è¿½åŠ </button>
                    <button class="btn btn-success" onclick="exportToExcel()" id="btnExportExcel">Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <button class="btn btn-info" onclick="showSettings()">Google é€£æºè¨­å®š</button>
                    
                    <button class="btn btn-info" onclick="sortByDueDate(true, this)">ğŸ“… æœŸæ—¥è¿‘ã„é †</button>
                    <button class="btn btn-secondary" onclick="sortByDueDate(false, this)">ğŸ“… æœŸæ—¥é ã„é †</button>
                    <button class="btn btn-info" onclick="sortByLastUpdated(true, this)">ğŸ•’ æ›´æ–°æ–°ã—ã„é †</button>
                    <button class="btn btn-secondary" onclick="sortByLastUpdated(false, this)">ğŸ•’ æ›´æ–°å¤ã„é †</button>
                    
                    <select id="assignedToFilter" onchange="updateAssignedToFilter()" class="btn btn-secondary" style="min-width: 150px;">
                        <option value="">æ‹…å½“è€…: å…¨ã¦</option>
                    </select>
                    
                    <button class="btn btn-secondary" onclick="refreshData()">ãƒ‡ãƒ¼ã‚¿æ›´æ–°</button>
                    <button class="btn btn-danger" onclick="bulkDeleteCompleted()" id="btnBulkDelete">0å††æ¡ˆä»¶ã‚’ä¸€æ‹¬å‰Šé™¤</button>
                </div>
            </div>

            <div class="search-container">
                <input type="text" class="search-input" id="searchInput" placeholder="æ¤œç´¢ï¼ˆè«‹æ±‚å…ˆåã€æ‹…å½“è€…ã€é›»è©±ç•ªå·ã€å‚™è€ƒï¼‰" oninput="applyAllFilters()">
            </div>

            <div id="emptyState" class="empty-state" style="display: none;">
                <h3>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</h3>
                <p>Google é€£æºè¨­å®šã‹ã‚‰åŒæœŸã™ã‚‹ã‹ã€æ–°è¦ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>
                <button class="btn btn-info" onclick="showSettings()">Google é€£æºè¨­å®š</button>
            </div>

            <div class="table-container">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th onclick="sortTable(0)">è«‹æ±‚å…ˆå</th>
                            <th onclick="sortTable(1)">æœªåé‡‘é¡</th>
                            <th onclick="sortTable(2)">æœŸæ—¥</th>
                            <th onclick="sortTable(3)">è¶…éæ—¥æ•°</th>
                            <th onclick="sortTable(4)">å…¥é‡‘äºˆå®šæ—¥</th>
                            <th onclick="sortTable(5)">é€²æ—</th>
                            <th onclick="sortTable(6)">æ‹…å½“</th>
                            <th onclick="sortTable(7)">é›»è©±ç•ªå·</th>
                            <th onclick="sortTable(8)">æœ€çµ‚æ›´æ–°</th>
                            <th onclick="sortTable(9)">å‚™è€ƒ</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>

            <div id="cardContainer" class="card-container"></div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">æ–°è¦è¿½åŠ </h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="editForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>è«‹æ±‚å…ˆå *</label>
                        <input type="text" id="editSchoolName" required>
                    </div>
                    <div class="form-group">
                        <label>æœªåé‡‘é¡ *</label>
                        <input type="text" id="editAmount" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>æœŸæ—¥ *</label>
                        <input type="date" id="editDueDate" required>
                    </div>
                    <div class="form-group">
                        <label>å…¥é‡‘äºˆå®šæ—¥</label>
                        <input type="date" id="editPaymentDate">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>é€²æ— *</label>
                        <select id="editProgress" required>
                            <option value="æœªå¯¾å¿œ">æœªå¯¾å¿œ</option>
                            <option value="æ¶é›»ä¸åœ¨">æ¶é›»ä¸åœ¨</option>
                            <option value="æ¶é›»å®Œäº†">æ¶é›»å®Œäº†</option>
                            <option value="ãƒ¡ãƒ¼ãƒ«æ¸ˆ">ãƒ¡ãƒ¼ãƒ«æ¸ˆ</option>
                            <option value="LINEæ¸ˆ">LINEæ¸ˆ</option>
                            <option value="å…¥é‡‘æ¸ˆ">å…¥é‡‘æ¸ˆ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æ‹…å½“è€… *</label>
                        <select id="editAssignedTo" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="è°·å£">è°·å£</option>
                            <option value="å³¶è°·">å³¶è°·</option>
                            <option value="é–€æˆ¸">é–€æˆ¸</option>
                            <option value="æ¢¨æœ¨">æ¢¨æœ¨</option>
                            <option value="æ‘ä¸Š">æ‘ä¸Š</option>
                            <option value="å…«æœ¨">å…«æœ¨</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>é›»è©±ç•ªå·</label>
                        <input type="tel" id="editPhone" placeholder="03-1234-5678">
                    </div>
                </div>
                <div class="form-group">
                    <label>å‚™è€ƒ</label>
                    <textarea id="editNotes" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"></textarea>
                </div>
                <div style="margin-top: 20px; text-align: right;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()" style="margin-right: 10px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç·¨é›†å±¥æ­´</h3>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <button class="btn btn-sm btn-outline-primary" onclick="toggleHistorySort()" id="historySortBtn">
                        ğŸ”„ æ–°ã—ã„é †
                    </button>
                    <span class="close" onclick="closeHistoryModal()">&times;</span>
                </div>
            </div>
            <div id="historyContent">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>æ—¥æ™‚</th>
                            <th>ç·¨é›†è€…</th>
                            <th>é …ç›®</th>
                            <th>å¤‰æ›´å‰</th>
                            <th>å¤‰æ›´å¾Œ</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody"></tbody>
                </table>
                <div id="mobileHistoryContainer" class="mobile-history"></div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // v2.9å®Œæˆç‰ˆ: å¡¾åˆ¥ç·¨é›†å±¥æ­´ãƒ»æœ€çµ‚æ›´æ–°è¡¨ç¤ºæœ€é©åŒ–
        // ========================================

        // åŸºç›¤ã‚·ã‚¹ãƒ†ãƒ æ©Ÿèƒ½
        function formatTelForIPhone(phoneNumber) {
            return String(phoneNumber || '').replace(/[^\d+]/g, '');
        }

        function isIOS() {
            return /iPhone|iPad|iPod/i.test(navigator.userAgent);
        }

        // ãƒ¢ãƒã‚¤ãƒ«ç”¨æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆâ—‹æœˆâ—‹æ—¥â—‹:â—‹å½¢å¼ï¼‰
        function formatDateTimeMobile(isoString) {
            if (!isoString) return '-';
            try {
                const date = new Date(isoString);
                if (isNaN(date.getTime())) return String(isoString);
                
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const hour = date.getHours();
                const minute = date.getMinutes().toString().padStart(2, '0');
                
                return `${month}æœˆ${day}æ—¥ ${hour}:${minute}`;
            } catch (error) {
                return String(isoString) || '-';
            }
        }

        // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDateTime(isoString) {
            if (!isoString) return '-';
            try {
                const date = new Date(isoString);
                if (isNaN(date.getTime())) return String(isoString);
                return date.toLocaleString('ja-JP', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return String(isoString) || '-';
            }
        }

        // æ—¥ä»˜ã®ã¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆâ—‹æœˆâ—‹æ—¥å½¢å¼ï¼‰
        function formatDateMobile(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return String(dateString);
                
                const month = date.getMonth() + 1;
                const day = date.getDate();
                
                return `${month}æœˆ${day}æ—¥`;
            } catch (error) {
                return String(dateString) || '-';
            }
        }

        function getCurrentDateTimeISO() {
            return new Date().toISOString();
        }

        function calculateOverdueDays(dueDate) {
            if (!dueDate) return null;
            const due = new Date(dueDate);
            const today = new Date();
            due.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0);
            const diffTime = today - due;
            return Math.floor(diffTime / (1000 * 60 * 60 * 24));
        }

        function parseAmountSmart(value) {
            if (value == null || value === '') return 0;
            if (typeof value === 'number' && isFinite(value)) return Math.round(value);
            
            let str = String(value).trim();
            if (!str) return 0;
            
            let sign = 1;
            if (str.startsWith('-') || str.startsWith('â–²') || str.startsWith('â–³')) {
                sign = -1;
                str = str.slice(1).trim();
            }
            
            str = str.replace(/[Â¥ï¿¥$â‚¬Â£,\s]/g, '');
            
            if (str.includes('å„„') || str.includes('ä¸‡') || str.includes('åƒ')) {
                let total = 0;
                const okuMatch = str.match(/([\d.]+)\s*å„„/);
                if (okuMatch) total += parseFloat(okuMatch[1]) * 100000000;
                const manMatch = str.match(/([\d.]+)\s*ä¸‡/);
                if (manMatch) total += parseFloat(manMatch[1]) * 10000;
                const senMatch = str.match(/([\d.]+)\s*åƒ/);
                if (senMatch) total += parseFloat(senMatch[1]) * 1000;
                const remaining = str.replace(/([\d.]+)\s*[å„„ä¸‡åƒ]/g, '').replace(/[^\d.]/g, '');
                if (remaining && /\d/.test(remaining)) total += parseFloat(remaining);
                return Math.round(sign * (total || 0));
            }
            
            const cleaned = str.replace(/[^\d.]/g, '');
            const num = parseFloat(cleaned);
            if (!isFinite(num)) return 0;
            return Math.round(sign * num);
        }

        function parseAmount(value) {
            return parseAmountSmart(value);
        }

        function isZeroAmountRecord(record) {
            return parseAmount(record.amount) <= 0;
        }

        function showSyncIndicator(message, type = 'info') {
            const indicator = document.getElementById('syncIndicator');
            indicator.textContent = message;
            indicator.className = `sync-indicator ${type}`;
            indicator.style.display = 'block';
            setTimeout(() => { indicator.style.display = 'none'; }, 3000);
        }

        function isAppsScriptUrl(url) {
            return /https:\/\/script\.google\.com\/macros\/s\/.+\/exec/i.test(url);
        }

        // ========================================
        // æ–°æ©Ÿèƒ½: å¡¾åˆ¥ç·¨é›†å±¥æ­´ã®æœ€çµ‚æ›´æ–°æ™‚åˆ»å–å¾—ã‚·ã‚¹ãƒ†ãƒ 
        // ========================================

        // å„å¡¾ã®ç·¨é›†å±¥æ­´ã‹ã‚‰æœ€æ–°ã®æ—¥æ™‚ã‚’å–å¾—ã™ã‚‹ãƒãƒƒãƒ—
        let schoolLastEditMap = new Map();

        // ç·¨é›†å±¥æ­´ãƒãƒƒãƒ—ã‚’æ§‹ç¯‰ãƒ»æ›´æ–°
        function buildSchoolLastEditMap() {
            schoolLastEditMap.clear();
            
            if (!editHistory || editHistory.length === 0) return;
            
            editHistory.forEach(entry => {
                if (!entry.schoolName || !entry.editDate) return;
                
                const entryTime = new Date(entry.editDate);
                if (isNaN(entryTime.getTime())) return;
                
                const currentLatest = schoolLastEditMap.get(entry.schoolName);
                if (!currentLatest || entryTime > currentLatest) {
                    schoolLastEditMap.set(entry.schoolName, entryTime);
                }
            });
        }

        // ç‰¹å®šã®å¡¾ã®æœ€çµ‚ç·¨é›†æ—¥æ™‚ã‚’å–å¾—
        function getSchoolLastEditTime(schoolName) {
            if (!schoolName) return null;
            return schoolLastEditMap.get(schoolName) || null;
        }

        // ç‰¹å®šã®å¡¾ã®æœ€çµ‚ç·¨é›†æ—¥æ™‚ã‚’è¡¨ç¤ºç”¨ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatSchoolLastEdit(schoolName) {
            const lastEditTime = getSchoolLastEditTime(schoolName);
            if (!lastEditTime) return '-';
            return formatDateTime(lastEditTime.toISOString());
        }

        // ç‰¹å®šã®å¡¾ã®æœ€çµ‚ç·¨é›†æ—¥æ™‚ã‚’ãƒ¢ãƒã‚¤ãƒ«ç”¨ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatSchoolLastEditMobile(schoolName) {
            const lastEditTime = getSchoolLastEditTime(schoolName);
            if (!lastEditTime) return '-';
            return formatDateTimeMobile(lastEditTime.toISOString());
        }

        // ========================================
        // æ”¹å–„: å…¨ä½“ã®æœ€çµ‚ç·¨é›†æ™‚åˆ»è¡¨ç¤ºï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ç”¨ï¼‰
        // ========================================

        function updateLastEditInfo() {
            const lastEditInfoElement = document.getElementById('lastEditInfo');
            if (!lastEditInfoElement) return;

            if (!editHistory || editHistory.length === 0) {
                lastEditInfoElement.textContent = 'æœ€çµ‚ç·¨é›†: å±¥æ­´ãªã—';
                return;
            }
            
            // ç·¨é›†å±¥æ­´ã‹ã‚‰æœ€æ–°ã®ç·¨é›†æ—¥æ™‚ã‚’å–å¾—
            const latestEdit = editHistory.reduce((latest, entry) => {
                if (!entry.editDate) return latest;
                
                const entryTime = new Date(entry.editDate);
                if (isNaN(entryTime.getTime())) return latest;
                
                return entryTime > latest ? entryTime : latest;
            }, new Date('1900-01-01'));
            
            // æœ‰åŠ¹ãªç·¨é›†æ—¥æ™‚ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
            if (latestEdit.getTime() === new Date('1900-01-01').getTime()) {
                lastEditInfoElement.textContent = 'æœ€çµ‚ç·¨é›†: ä¸æ˜';
                return;
            }
            
            // ç¾åœ¨æ™‚åˆ»ã¨ã®å·®åˆ†ã‚’è¨ˆç®—ã—ã¦è¡¨ç¤ºã‚’èª¿æ•´
            const now = new Date();
            const diffMinutes = Math.floor((now - latestEdit) / (1000 * 60));
            
            let displayText = `æœ€çµ‚ç·¨é›†: ${formatDateTimeMobile(latestEdit.toISOString())}`;
            
            // ç·¨é›†ã‹ã‚‰ã®çµŒéæ™‚é–“ã‚’ä½µè¨˜
            if (diffMinutes < 60) {
                displayText += ` (${diffMinutes}åˆ†å‰)`;
            } else if (diffMinutes < 1440) {
                displayText += ` (${Math.floor(diffMinutes / 60)}æ™‚é–“å‰)`;
            } else {
                displayText += ` (${Math.floor(diffMinutes / 1440)}æ—¥å‰)`;
            }
            
            lastEditInfoElement.textContent = displayText;
        }

        // ========================================
        // æ”¹å–„: ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–å±¥æ­´è¡¨ç¤º
        // ========================================

        async function showHistory(schoolName, customerCode = '') {
            currentHistorySchool = schoolName;
            let serverHistory = [];
            let localHistory = [];
            
            try {
                // ãƒ­ãƒ¼ã‚«ãƒ«å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
                const savedHistory = localStorage.getItem('editHistory');
                if (savedHistory) {
                    localHistory = JSON.parse(savedHistory).filter(h => h.schoolName === schoolName);
                }
                
                const apiUrl = document.getElementById('sheetsUrl').value.trim();
                
                // Apps Script URLãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—
                if (isAppsScriptUrl(apiUrl)) {
                    const record = allData.find(r => r.schoolName === schoolName);
                    const targetCustomerCode = customerCode || (record ? record.customerCode : '');
                    
                    const params = new URLSearchParams({
                        action: 'getHistory',
                        customerCode: targetCustomerCode || '',
                        schoolName: schoolName
                    });
                    
                    showSyncIndicator('å±¥æ­´ã‚’å–å¾—ä¸­...', 'info');
                    
                    const response = await fetch(`${apiUrl}?${params.toString()}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.error) {
                        console.warn('ã‚µãƒ¼ãƒãƒ¼å±¥æ­´å–å¾—ã‚¨ãƒ©ãƒ¼:', result.error);
                        showSyncIndicator('ã‚µãƒ¼ãƒãƒ¼å±¥æ­´å–å¾—å¤±æ•—', 'error');
                    } else if (result.history) {
                        serverHistory = result.history;
                        showSyncIndicator(`ã‚µãƒ¼ãƒãƒ¼å±¥æ­´å–å¾—å®Œäº† (${serverHistory.length}ä»¶)`, 'success');
                    }
                }
                
                // ã‚µãƒ¼ãƒãƒ¼å±¥æ­´ã¨ãƒ­ãƒ¼ã‚«ãƒ«å±¥æ­´ã‚’çµ±åˆ
                editHistory = mergeHistories(serverHistory, localHistory);
                
            } catch (error) {
                console.error('å±¥æ­´å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                showSyncIndicator('å±¥æ­´å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«å±¥æ­´ã®ã¿ä½¿ç”¨
                editHistory = localHistory;
            }
            
            renderHistoryTable();
            document.getElementById('historyModal').style.display = 'block';
        }

        // ã‚µãƒ¼ãƒãƒ¼å±¥æ­´ã¨ãƒ­ãƒ¼ã‚«ãƒ«å±¥æ­´ã®çµ±åˆé–¢æ•°
        function mergeHistories(serverHistory, localHistory) {
            const merged = [...serverHistory];
            const serverEditDates = new Set(serverHistory.map(h => h.editDate));
            
            // ãƒ­ãƒ¼ã‚«ãƒ«å±¥æ­´ã§ã‚µãƒ¼ãƒãƒ¼ã«ãªã„é …ç›®ã‚’è¿½åŠ 
            localHistory.forEach(localItem => {
                if (!serverEditDates.has(localItem.editDate)) {
                    merged.push({
                        ...localItem,
                        source: 'local' // ãƒ­ãƒ¼ã‚«ãƒ«ç”±æ¥ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ãƒ•ãƒ©ã‚°
                    });
                }
            });
            
            // ç·¨é›†æ—¥æ™‚ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
            return merged.sort((a, b) => new Date(b.editDate) - new Date(a.editDate));
        }

        // å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¡¨ç¤ºã‚’æ”¹è‰¯ï¼ˆãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œï¼‰
        function renderHistoryTable() {
            const schoolHistory = editHistory.filter(h => h.schoolName === currentHistorySchool);
            const tbody = document.getElementById('historyTableBody');
            const mobileContainer = document.getElementById('mobileHistoryContainer');
            
            tbody.innerHTML = '';
            mobileContainer.innerHTML = '';
            
            const sortedHistory = [...schoolHistory].sort((a, b) => {
                const dateA = new Date(a.editDate);
                const dateB = new Date(b.editDate);
                return historyNewestFirst ? dateB - dateA : dateA - dateB;
            });
            
            // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º
            sortedHistory.forEach(entry => {
                const tr = document.createElement('tr');
                
                const tdDate = document.createElement('td');
                tdDate.textContent = formatDateTime(entry.editDate);
                
                const tdBy = document.createElement('td');
                tdBy.textContent = entry.editedBy || entry.editor || '';
                
                const tdField = document.createElement('td');
                tdField.textContent = entry.field;
                
                const tdOld = document.createElement('td');
                tdOld.textContent = entry.oldValue;
                
                const tdNew = document.createElement('td');
                tdNew.textContent = entry.newValue;
                
                tr.appendChild(tdDate);
                tr.appendChild(tdBy);
                tr.appendChild(tdField);
                tr.appendChild(tdOld);
                tr.appendChild(tdNew);
                
                tbody.appendChild(tr);
            });

            // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
            sortedHistory.forEach(entry => {
                const item = document.createElement('div');
                item.className = 'mobile-history-item';
                
                const header = document.createElement('div');
                header.className = 'mobile-history-header';
                
                const dateDiv = document.createElement('div');
                dateDiv.className = 'mobile-history-date';
                dateDiv.textContent = formatDateTimeMobile(entry.editDate);
                
                const editorDiv = document.createElement('div');
                editorDiv.className = 'mobile-history-editor';
                editorDiv.textContent = entry.editedBy || entry.editor || '';
                
                header.appendChild(dateDiv);
                header.appendChild(editorDiv);
                
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'mobile-history-field';
                fieldDiv.textContent = entry.field;
                
                const changeDiv = document.createElement('div');
                changeDiv.className = 'mobile-history-change';
                
                const oldSpan = document.createElement('span');
                oldSpan.className = 'mobile-history-old';
                
                const newSpan = document.createElement('span');
                newSpan.className = 'mobile-history-new';
                
                const arrowSpan = document.createElement('span');
                arrowSpan.className = 'mobile-history-arrow';
                arrowSpan.textContent = 'â†’';
                
                // å…¥é‡‘äºˆå®šæ—¥ã®å¤‰æ›´ã®å ´åˆã€ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’é©ç”¨
                if (entry.field === 'å…¥é‡‘äºˆå®šæ—¥') {
                    oldSpan.textContent = entry.oldValue ? formatDateMobile(entry.oldValue) : '-';
                    newSpan.textContent = entry.newValue ? formatDateMobile(entry.newValue) : '-';
                } else {
                    oldSpan.textContent = entry.oldValue || '-';
                    newSpan.textContent = entry.newValue || '-';
                }
                
                changeDiv.appendChild(oldSpan);
                changeDiv.appendChild(arrowSpan);
                changeDiv.appendChild(newSpan);
                
                item.appendChild(header);
                item.appendChild(fieldDiv);
                item.appendChild(changeDiv);
                
                mobileContainer.appendChild(item);
            });
            
            const btn = document.getElementById('historySortBtn');
            btn.textContent = historyNewestFirst ? 'ğŸ”„ æ–°ã—ã„é †' : 'ğŸ”„ å¤ã„é †';
        }

        function toggleHistorySort() {
            historyNewestFirst = !historyNewestFirst;
            renderHistoryTable();
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
        }

        // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±
        const accounts = {
            'taniguchi': { password: 'Chuoh1400', role: 'admin', name: 'è°·å£' },
            'shimatani': { password: 'shimatani1400', role: 'staff', name: 'å³¶è°·' },
            'mondo': { password: 'mondo1400', role: 'staff', name: 'é–€æˆ¸' },
            'nashiki': { password: 'nashiki1400', role: 'staff', name: 'æ¢¨æœ¨' },
            'murakami': { password: 'murakami1400', role: 'staff', name: 'æ‘ä¸Š' },
            'yagi': { password: 'yagi1400', role: 'staff', name: 'å…«æœ¨' }
        };

        const adminNames = new Set(
            Object.values(accounts)
                .filter(account => account.role === 'admin')
                .map(account => account.name)
        );

        let currentUser = null;
        let allData = [];
        let filteredData = [];
        let editHistory = [];
        let sortColumn = -1;
        let sortDirection = 1;
        let editingIndex = -1;
        let autoUpdateTimer = null;
        let historyNewestFirst = true;
        let currentHistorySchool = null;
        let currentSearchTerm = '';
        let currentAssignedToFilter = '';
        let syncing = false;

        // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');

            if (!username || !password) {
                showError(errorDiv, 'ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (accounts[username] && accounts[username].password === password) {
                currentUser = {
                    id: username,
                    name: accounts[username].name,
                    role: accounts[username].role
                };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showMainScreen();
            } else {
                showError(errorDiv, 'ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™');
            }
        }

        function showMainScreen() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'block';
            document.getElementById('currentUserName').textContent = `${currentUser.name}ï¼ˆ${currentUser.id}ï¼‰`;
            document.getElementById('currentUserRole').textContent = currentUser.role === 'admin' ? 'ç®¡ç†è€…' : 'æ‹…å½“è€…';
            updateControlButtonsVisibility();
            loadData();
            loadSettings();
            setupAutoUpdate();
        }

        function updateControlButtonsVisibility() {
            const isAdmin = (currentUser && currentUser.role === 'admin');
            // Googleé€£æºè¨­å®šãƒœã‚¿ãƒ³ã‚’ç®¡ç†è€…é™å®šãƒªã‚¹ãƒˆã‹ã‚‰é™¤å¤–
            const adminButtons = ['btnAddRecord', 'btnExportExcel', 'btnBulkDelete'];
            adminButtons.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button) button.style.display = isAdmin ? '' : 'none';
            });
            const resetBtn = document.getElementById('btnResetLocal');
            if (resetBtn) resetBtn.style.display = currentUser ? '' : 'none';
        }

        function requireAdminAccess(functionName) {
            if (!currentUser || currentUser.role !== 'admin') {
                alert(`${functionName}ã¯ç®¡ç†è€…ã®ã¿åˆ©ç”¨ã§ãã¾ã™`);
                return false;
            }
            return true;
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            if (autoUpdateTimer) { clearInterval(autoUpdateTimer); autoUpdateTimer = null; }
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainScreen').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function loadData() {
            const savedData = localStorage.getItem('jukuSystemData');
            if (savedData) {
                try { 
                    allData = JSON.parse(savedData); 
                } catch (error) { 
                    console.error('Data loading error:', error);
                    allData = []; 
                }
            } else {
                allData = [];
            }
            
            // ç·¨é›†å±¥æ­´ã‚‚èª­ã¿è¾¼ã¿
            const history = localStorage.getItem('editHistory');
            if (history) {
                editHistory = JSON.parse(history);
            }
            
            // ç·¨é›†å±¥æ­´ãƒãƒƒãƒ—ã‚’æ§‹ç¯‰
            buildSchoolLastEditMap();
            
            populateAssignedToFilter();
            applyAllFilters();
            updateLastEditInfo();
        }

        function applyAllFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            currentSearchTerm = searchTerm;
            let tempFiltered = [...allData];

            if (currentAssignedToFilter) {
                tempFiltered = tempFiltered.filter(row => 
                    (row.assignedTo || '') === currentAssignedToFilter
                );
            }

            if (searchTerm) {
                tempFiltered = tempFiltered.filter(row => 
                    (row.schoolName || '').toLowerCase().includes(searchTerm) ||
                    (row.assignedTo || '').toLowerCase().includes(searchTerm) ||
                    (row.phone || '').includes(searchTerm) ||
                    (row.notes || '').toLowerCase().includes(searchTerm)
                );
            }

            const nonZeroRecords = tempFiltered.filter(row => !isZeroAmountRecord(row));
            const zeroRecords = tempFiltered.filter(row => isZeroAmountRecord(row));
            filteredData = [...nonZeroRecords, ...zeroRecords];

            renderTable();
            updateStats();
            updateEmptyState();
        }

        function updateEmptyState() {
            const isEmpty = filteredData.length === 0;
            const emptyState = document.getElementById('emptyState');
            const tableContainer = document.querySelector('.table-container');
            const cardContainer = document.getElementById('cardContainer');
            
            if (isEmpty) {
                emptyState.style.display = 'block';
                tableContainer.style.display = 'none';
                cardContainer.style.display = 'none';
            } else {
                emptyState.style.display = 'none';
                if (window.innerWidth <= 768) {
                    tableContainer.style.display = 'none';
                    cardContainer.style.display = 'block';
                } else {
                    tableContainer.style.display = 'block';
                    cardContainer.style.display = 'none';
                }
            }
        }

        function updateAssignedToFilter() {
            currentAssignedToFilter = document.getElementById('assignedToFilter').value;
            applyAllFilters();
        }

        function populateAssignedToFilter() {
            const select = document.getElementById('assignedToFilter');
            if (!select) return;
            const currentValue = select.value;
            const assignedPersons = new Set();
            
            allData.forEach(row => {
                const assignedTo = row.assignedTo;
                if (assignedTo && !adminNames.has(assignedTo)) {
                    assignedPersons.add(assignedTo);
                }
            });

            select.innerHTML = '<option value="">æ‹…å½“è€…: å…¨ã¦</option>';
            Array.from(assignedPersons).sort().forEach(person => {
                const option = document.createElement('option');
                option.value = person;
                option.textContent = person;
                select.appendChild(option);
            });

            if (adminNames.has(currentValue)) {
                select.value = '';
                currentAssignedToFilter = '';
            } else {
                select.value = currentValue;
            }
        }

        function renderTable() {
            renderTableView();
            renderCardView();
        }

        // â˜…é‡è¦ãªä¿®æ­£ç‚¹ï¼šãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤ºã§å„å¡¾ã®ç·¨é›†å±¥æ­´ã‹ã‚‰æœ€çµ‚æ›´æ–°ã‚’å–å¾—
        function renderTableView() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            filteredData.forEach((row, index) => {
                const tr = document.createElement('tr');
                const overdueDays = calculateOverdueDays(row.dueDate);
                const isZeroAmount = isZeroAmountRecord(row);

                if (isZeroAmount) {
                    tr.classList.add('completed-gray-row');
                } else if (overdueDays >= 10) {
                    tr.classList.add('overdue-pink-row');
                }

                const tdSchool = document.createElement('td');
                tdSchool.textContent = row.schoolName || '';

                const tdAmount = document.createElement('td');
                tdAmount.textContent = 'Â¥' + (parseAmount(row.amount) || 0).toLocaleString();
                tdAmount.classList.add('amount-display');

                const tdDue = document.createElement('td');
                tdDue.textContent = isZeroAmount ? '-' : (row.dueDate || '');

                const tdOverdue = document.createElement('td');
                if (isZeroAmount || overdueDays === null || overdueDays <= 0) {
                    tdOverdue.textContent = '-';
                } else {
                    tdOverdue.textContent = `${overdueDays}æ—¥`;
                    if (overdueDays >= 3) tdOverdue.classList.add('overdue-red');
                }

                const tdPay = document.createElement('td');
                tdPay.textContent = row.paymentDate || '-';

                const tdProg = document.createElement('td');
                tdProg.textContent = row.progress || '';

                const tdAssign = document.createElement('td');
                tdAssign.textContent = row.assignedTo || '';

                const tdPhone = document.createElement('td');
                const phoneDiv = document.createElement('div');
                phoneDiv.className = 'phone-contact';
                
                if (isIOS() && currentUser && currentUser.role === 'staff' && row.phone) {
                    const phoneLink = document.createElement('a');
                    phoneLink.href = 'tel:' + formatTelForIPhone(row.phone);
                    phoneLink.className = 'phone-number';
                    phoneLink.textContent = row.phone;
                    phoneLink.style.color = '#007bff';
                    phoneLink.style.textDecoration = 'underline';
                    phoneDiv.appendChild(phoneLink);

                    const phoneBtn = document.createElement('a');
                    phoneBtn.href = 'tel:' + formatTelForIPhone(row.phone);
                    phoneBtn.className = 'action-btn phone-btn';
                    phoneBtn.textContent = 'ğŸ“';
                    phoneDiv.appendChild(phoneBtn);
                } else {
                    const phoneSpan = document.createElement('span');
                    phoneSpan.className = 'phone-number';
                    phoneSpan.textContent = row.phone || '-';
                    phoneDiv.appendChild(phoneSpan);
                }
                tdPhone.appendChild(phoneDiv);

                // â˜…ä¿®æ­£ï¼šå„å¡¾ã®ç·¨é›†å±¥æ­´ã‹ã‚‰æœ€çµ‚æ›´æ–°ã‚’è¡¨ç¤º
                const tdLastUpdated = document.createElement('td');
                tdLastUpdated.textContent = formatSchoolLastEdit(row.schoolName);
                tdLastUpdated.style.fontSize = '0.85em';
                tdLastUpdated.style.color = '#666';
                tdLastUpdated.style.whiteSpace = 'nowrap';

                const tdNotes = document.createElement('td');
                tdNotes.textContent = row.notes || '';

                const tdActions = document.createElement('td');
                const editBtn = document.createElement('button');
                editBtn.className = 'action-btn edit-btn';
                editBtn.textContent = 'ç·¨é›†';
                editBtn.addEventListener('click', () => editRecord(index));
                tdActions.appendChild(editBtn);

                if (shouldShowDeleteButton()) {
                    const delBtn = document.createElement('button');
                    delBtn.className = 'action-btn delete-btn';
                    delBtn.textContent = 'å‰Šé™¤';
                    delBtn.addEventListener('click', () => deleteRecord(index));
                    tdActions.appendChild(delBtn);
                }

                const histBtn = document.createElement('button');
                histBtn.className = 'action-btn history-btn';
                histBtn.textContent = 'å±¥æ­´';
                histBtn.addEventListener('click', () => showHistory(row.schoolName, row.customerCode));
                tdActions.appendChild(histBtn);

                tr.appendChild(tdSchool);
                tr.appendChild(tdAmount);
                tr.appendChild(tdDue);
                tr.appendChild(tdOverdue);
                tr.appendChild(tdPay);
                tr.appendChild(tdProg);
                tr.appendChild(tdAssign);
                tr.appendChild(tdPhone);
                tr.appendChild(tdLastUpdated);
                tr.appendChild(tdNotes);
                tr.appendChild(tdActions);

                tbody.appendChild(tr);
            });
        }

        // â˜…é‡è¦ãªä¿®æ­£ç‚¹ï¼šã‚«ãƒ¼ãƒ‰è¡¨ç¤ºã§å„å¡¾ã®ç·¨é›†å±¥æ­´ã‹ã‚‰æœ€çµ‚æ›´æ–°ã‚’å–å¾—
        function renderCardView() {
            const container = document.getElementById('cardContainer');
            container.innerHTML = '';

            filteredData.forEach((row, index) => {
                const overdueDays = calculateOverdueDays(row.dueDate);
                const isZeroAmount = isZeroAmountRecord(row);
                
                const card = document.createElement('div');
                card.className = 'juku-card';
                
                if (isZeroAmount) {
                    card.classList.add('completed-gray');
                } else if (overdueDays >= 10) {
                    card.classList.add('overdue-pink');
                }

                const header = document.createElement('div');
                header.className = 'card-header';
                
                const schoolName = document.createElement('div');
                schoolName.className = 'card-school-name';
                schoolName.textContent = row.schoolName || '';
                
                const amount = document.createElement('div');
                amount.className = 'card-amount';
                amount.textContent = 'Â¥' + (parseAmount(row.amount) || 0).toLocaleString();
                
                header.appendChild(schoolName);
                header.appendChild(amount);

                const dueDateRow = document.createElement('div');
                dueDateRow.className = 'card-info-row';
                
                const dueDateLabel = document.createElement('span');
                dueDateLabel.className = 'card-info-label';
                dueDateLabel.textContent = 'æœŸæ—¥:';
                
                const dueDateValue = document.createElement('span');
                dueDateValue.textContent = isZeroAmount ? '-' : (row.dueDate || 'æœªè¨­å®š');
                
                const overdueSpan = document.createElement('span');
                overdueSpan.className = 'card-overdue';
                
                if (isZeroAmount || overdueDays === null || overdueDays <= 0) {
                    overdueSpan.textContent = '-';
                    overdueSpan.classList.add('normal');
                } else if (overdueDays >= 3) {
                    overdueSpan.textContent = `${overdueDays}æ—¥`;
                    overdueSpan.classList.add('danger');
                } else {
                    overdueSpan.textContent = `${overdueDays}æ—¥`;
                    overdueSpan.classList.add('warning');
                }
                
                dueDateRow.appendChild(dueDateLabel);
                dueDateRow.appendChild(dueDateValue);
                dueDateRow.appendChild(overdueSpan);

                const assignRow = document.createElement('div');
                assignRow.className = 'card-info-row';
                
                const assignLabel = document.createElement('span');
                assignLabel.className = 'card-info-label';
                assignLabel.textContent = 'æ‹…å½“:';
                
                const assignValue = document.createElement('span');
                assignValue.textContent = row.assignedTo || '';
                
                const progressValue = document.createElement('span');
                progressValue.textContent = `é€²æ—: ${row.progress || ''}`;
                
                assignRow.appendChild(assignLabel);
                assignRow.appendChild(assignValue);
                assignRow.appendChild(progressValue);

                const phoneRow = document.createElement('div');
                phoneRow.className = 'card-info-row';
                
                const phoneLabel = document.createElement('span');
                phoneLabel.className = 'card-info-label';
                phoneLabel.textContent = 'é›»è©±:';
                
                const phoneValue = document.createElement('span');
                if (isIOS() && currentUser && currentUser.role === 'staff' && row.phone) {
                    const phoneLink = document.createElement('a');
                    phoneLink.href = 'tel:' + formatTelForIPhone(row.phone);
                    phoneLink.className = 'phone-number';
                    phoneLink.textContent = row.phone;
                    phoneLink.style.color = '#007bff';
                    phoneLink.style.textDecoration = 'underline';
                    phoneValue.appendChild(phoneLink);
                } else {
                    phoneValue.className = 'phone-number';
                    phoneValue.textContent = row.phone || 'æœªç™»éŒ²';
                }
                phoneRow.appendChild(phoneLabel);
                phoneRow.appendChild(phoneValue);

                const paymentRow = document.createElement('div');
                paymentRow.className = 'card-info-row';
                
                const paymentLabel = document.createElement('span');
                paymentLabel.className = 'card-info-label';
                paymentLabel.textContent = 'å…¥é‡‘äºˆå®š:';
                
                const paymentValue = document.createElement('span');
                paymentValue.textContent = row.paymentDate || 'æœªè¨­å®š';
                
                paymentRow.appendChild(paymentLabel);
                paymentRow.appendChild(paymentValue);

                // â˜…ä¿®æ­£ï¼šå„å¡¾ã®ç·¨é›†å±¥æ­´ã‹ã‚‰æœ€çµ‚æ›´æ–°ã‚’è¡¨ç¤º
                const updateRow = document.createElement('div');
                updateRow.className = 'card-info-row';
                
                const updateLabel = document.createElement('span');
                updateLabel.className = 'card-info-label';
                updateLabel.textContent = 'æœ€çµ‚æ›´æ–°:';
                
                const updateValue = document.createElement('span');
                updateValue.style.fontSize = '0.85em';
                updateValue.style.color = '#666';
                updateValue.textContent = formatSchoolLastEditMobile(row.schoolName);
                
                updateRow.appendChild(updateLabel);
                updateRow.appendChild(updateValue);

                let notesRow = null;
                if (row.notes) {
                    notesRow = document.createElement('div');
                    notesRow.className = 'card-info-row';
                    
                    const notesLabel = document.createElement('span');
                    notesLabel.className = 'card-info-label';
                    notesLabel.textContent = 'å‚™è€ƒ:';
                    
                    const notesValue = document.createElement('span');
                    notesValue.textContent = row.notes.length > 30 ? row.notes.substring(0, 30) + '...' : row.notes;
                    
                    notesRow.appendChild(notesLabel);
                    notesRow.appendChild(notesValue);
                }

                const actions = document.createElement('div');
                actions.className = 'card-actions';

                if (isIOS() && currentUser && currentUser.role === 'staff') {
                    const phoneBtn = document.createElement('a');
                    phoneBtn.className = 'card-action-btn card-phone-btn';
                    
                    if (row.phone) {
                        phoneBtn.href = 'tel:' + formatTelForIPhone(row.phone);
                        phoneBtn.textContent = 'ğŸ“ ç™ºä¿¡';
                    } else {
                        phoneBtn.textContent = 'ğŸ“ æœªç™»éŒ²';
                        phoneBtn.style.opacity = '0.6';
                        phoneBtn.style.pointerEvents = 'none';
                    }
                    actions.appendChild(phoneBtn);
                }

                const editBtn = document.createElement('button');
                editBtn.className = 'card-action-btn card-edit-btn';
                editBtn.textContent = 'âœï¸ ç·¨é›†';
                editBtn.addEventListener('click', () => editRecord(index));
                actions.appendChild(editBtn);

                const histBtn = document.createElement('button');
                histBtn.className = 'card-action-btn card-history-btn';
                histBtn.textContent = 'ğŸ“‹ å±¥æ­´';
                histBtn.addEventListener('click', () => showHistory(row.schoolName, row.customerCode));
                actions.appendChild(histBtn);

                card.appendChild(header);
                card.appendChild(dueDateRow);
                card.appendChild(assignRow);
                card.appendChild(phoneRow);
                card.appendChild(paymentRow);
                card.appendChild(updateRow);
                if (notesRow) card.appendChild(notesRow);
                card.appendChild(actions);

                container.appendChild(card);
            });
        }

        function shouldShowDeleteButton() {
            return currentUser && currentUser.role === 'admin';
        }

        function updateStats() {
            const now = new Date();
            const activeData = filteredData.filter(row => !isZeroAmountRecord(row));
            
            const total = activeData.length;
            const totalAmount = activeData.reduce((sum, row) => sum + (parseAmount(row.amount) || 0), 0);
            const overdue = activeData.filter(row => row.dueDate && new Date(row.dueDate) < now).length;
            const dueSoon = activeData.filter(row => {
                if (!row.dueDate) return false;
                const diff = (new Date(row.dueDate) - now) / (1000 * 60 * 60 * 24);
                return diff >= 0 && diff <= 7;
            }).length;

            document.getElementById('totalRecords').textContent = total;
            document.getElementById('totalAmount').textContent = `Â¥${totalAmount.toLocaleString()}`;
            document.getElementById('overdueCount').textContent = overdue;
            document.getElementById('dueSoonCount').textContent = dueSoon;
        }

        function sortByDueDate(nearFirst = true, btn = null) {
            document.querySelectorAll('.controls .btn').forEach(b => b.classList.remove('sort-active'));
            if (btn) btn.classList.add('sort-active');

            const nonZeroRecords = filteredData.filter(row => !isZeroAmountRecord(row));
            const zeroRecords = filteredData.filter(row => isZeroAmountRecord(row));

            nonZeroRecords.sort((a, b) => {
                const dateA = a.dueDate ? new Date(a.dueDate) : new Date('2099-12-31');
                const dateB = b.dueDate ? new Date(b.dueDate) : new Date('2099-12-31');
                return nearFirst ? (dateA - dateB) : (dateB - dateA);
            });

            zeroRecords.sort((a, b) => {
                const dateA = a.dueDate ? new Date(a.dueDate) : new Date('2099-12-31');
                const dateB = b.dueDate ? new Date(b.dueDate) : new Date('2099-12-31');
                return nearFirst ? (dateA - dateB) : (dateB - dateA);
            });

            filteredData = [...nonZeroRecords, ...zeroRecords];
            renderTable();
            showTempMessage(nearFirst ? 'ğŸ“… æœŸæ—¥ãŒè¿‘ã„é †ã§è¡¨ç¤ºä¸­' : 'ğŸ“… æœŸæ—¥ãŒé ã„é †ã§è¡¨ç¤ºä¸­');
        }

        // â˜…ä¿®æ­£ï¼šç·¨é›†å±¥æ­´ãƒ™ãƒ¼ã‚¹ã®æœ€çµ‚æ›´æ–°ã‚½ãƒ¼ãƒˆ
        function sortByLastUpdated(newestFirst = true, btn = null) {
            document.querySelectorAll('.controls .btn').forEach(b => b.classList.remove('sort-active'));
            if (btn) btn.classList.add('sort-active');

            const nonZeroRecords = filteredData.filter(row => !isZeroAmountRecord(row));
            const zeroRecords = filteredData.filter(row => isZeroAmountRecord(row));

            const sortByEditHistory = (a, b) => {
                const dateA = getSchoolLastEditTime(a.schoolName) || new Date('1900-01-01');
                const dateB = getSchoolLastEditTime(b.schoolName) || new Date('1900-01-01');
                return newestFirst ? (dateB - dateA) : (dateA - dateB);
            };

            nonZeroRecords.sort(sortByEditHistory);
            zeroRecords.sort(sortByEditHistory);

            filteredData = [...nonZeroRecords, ...zeroRecords];
            renderTable();
            showTempMessage(newestFirst ? 'ğŸ•’ ç·¨é›†ãŒæ–°ã—ã„é †ã§è¡¨ç¤ºä¸­' : 'ğŸ•’ ç·¨é›†ãŒå¤ã„é †ã§è¡¨ç¤ºä¸­');
        }

        function showTempMessage(message) {
            const firstStatCard = document.querySelector('.stat-value');
            if (firstStatCard) {
                const originalText = firstStatCard.textContent;
                firstStatCard.textContent = message;
                firstStatCard.style.fontSize = '14px';
                firstStatCard.style.color = '#28a745';
                
                setTimeout(() => {
                    firstStatCard.textContent = originalText;
                    firstStatCard.style.fontSize = '24px';
                    firstStatCard.style.color = '#007bff';
                }, 3000);
            }
        }

        // ========================================
        // åŒæ–¹å‘åŒæœŸæ©Ÿèƒ½
        // ========================================

        async function syncFromSheets() {
            const rawUrl = document.getElementById('sheetsUrl').value.trim();
            if (!rawUrl) {
                document.getElementById('syncStatus').textContent = 'URLæœªè¨­å®š';
                return;
            }

            if (document.getElementById('editModal').style.display === 'block') {
                document.getElementById('syncStatus').textContent = 'ç·¨é›†ä¸­ã®ãŸã‚åŒæœŸå¾…æ©Ÿ';
                setTimeout(() => document.getElementById('syncStatus').textContent = '', 3000);
                return;
            }

            if (syncing) return;
            syncing = true;

            const status = document.getElementById('syncStatus');
            status.innerHTML = '<span class="loading"></span> åŒæœŸä¸­...';

            const apiMode = isAppsScriptUrl(rawUrl);
            
            try {
                if (apiMode) {
                    // Apps Script APIã‹ã‚‰JSONå–å¾—
                    const response = await fetch(`${rawUrl}?action=getData`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    
                    const result = await response.json();
                    if (result.error) throw new Error(result.error);

                    allData = (result.data || []).map(item => ({
                        customerCode: item.customerCode || '',
                        schoolName: item.schoolName || '',
                        amount: parseAmount(item.amount || 0),
                        dueDate: item.dueDate || '',
                        paymentDate: item.paymentDate || '',
                        progress: item.progress || 'æœªå¯¾å¿œ',
                        assignedTo: item.assignedTo || '',
                        phone: item.phone || '',
                        notes: item.notes || '',
                        lastUpdated: item.lastUpdated || '',
                        version: item.version || 1
                    }));
                } else {
                    throw new Error('Apps Script URLã®ã¿ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™');
                }

                localStorage.setItem('jukuSystemData', JSON.stringify(allData));
                
                // ç·¨é›†å±¥æ­´ãƒãƒƒãƒ—ã‚’å†æ§‹ç¯‰
                buildSchoolLastEditMap();
                
                populateAssignedToFilter();
                applyAllFilters();
                updateLastEditInfo();

                const timestamp = new Date();
                status.textContent = `âœ“ åŒæœŸå®Œäº† (${allData.length}ä»¶)`;
                showSyncIndicator(`åŒæœŸå®Œäº† (${allData.length}ä»¶)`, 'success');
                setTimeout(() => status.textContent = '', 3000);

            } catch (error) {
                console.error('åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                status.textContent = 'âœ— åŒæœŸå¤±æ•—: ' + error.message;
                showSyncIndicator('åŒæœŸå¤±æ•—: ' + error.message, 'error');
                setTimeout(() => status.textContent = '', 5000);
            } finally {
                syncing = false;
            }
        }

        // CORSå¯¾å¿œç‰ˆï¼šãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆå›é¿
        async function sendUpdatesToServer(updates) {
            const apiUrl = document.getElementById('sheetsUrl').value.trim();
            if (!isAppsScriptUrl(apiUrl) || updates.length === 0) return true;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'text/plain;charset=utf-8'
                    },
                    body: JSON.stringify({ action: 'updateRecords', updates })
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                const result = await response.json();

                if (result.conflicts && result.conflicts.length > 0) {
                    alert('ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ›´æ–°ã—ã¾ã—ãŸã€‚æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™ã€‚');
                    await syncFromSheets();
                    return false;
                }
                
                if (result.errors && result.errors.length > 0) {
                    alert('æ›´æ–°ã‚¨ãƒ©ãƒ¼: ' + result.errors[0].error);
                    return false;
                }

                if (result.success && result.success.length > 0) {
                    result.success.forEach(s => {
                        const rec = allData.find(r => r.customerCode === s.customerCode);
                        if (rec) rec.version = s.version;
                    });
                    localStorage.setItem('jukuSystemData', JSON.stringify(allData));
                }

                showSyncIndicator('ã‚µãƒ¼ãƒãƒ¼ã«åŒæœŸå®Œäº†', 'success');
                return true;

            } catch (error) {
                console.error('æ›´æ–°é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                throw error;
            }
        }

        function showAddModal() {
            if (!requireAdminAccess('æ–°è¦è¿½åŠ ')) return;
            editingIndex = -1;
            document.getElementById('modalTitle').textContent = 'æ–°è¦è¿½åŠ ';
            document.getElementById('editForm').reset();
            document.getElementById('editProgress').value = 'æœªå¯¾å¿œ';
            setFieldPermissions();
            document.getElementById('editModal').style.display = 'block';
        }

        function editRecord(index) {
            editingIndex = index;
            const record = filteredData[index];
            
            document.getElementById('modalTitle').textContent = 'ç·¨é›†';
            document.getElementById('editSchoolName').value = record.schoolName || '';
            document.getElementById('editAmount').value = (record.amount || '').toString();
            document.getElementById('editDueDate').value = record.dueDate || '';
            document.getElementById('editPaymentDate').value = record.paymentDate || '';
            document.getElementById('editProgress').value = record.progress || 'æœªå¯¾å¿œ';
            document.getElementById('editAssignedTo').value = record.assignedTo || '';
            document.getElementById('editPhone').value = record.phone || '';
            document.getElementById('editNotes').value = record.notes || '';
            
            setFieldPermissions();
            document.getElementById('editModal').style.display = 'block';
        }

        function setFieldPermissions() {
            const baseFields = ['editSchoolName', 'editAmount', 'editDueDate', 'editAssignedTo', 'editPhone'];
            
            if (currentUser.role === 'staff') {
                baseFields.forEach(id => document.getElementById(id).disabled = true);
                document.getElementById('editPaymentDate').disabled = false;
                document.getElementById('editProgress').disabled = false;
                document.getElementById('editNotes').disabled = false;
            } else {
                baseFields.forEach(id => document.getElementById(id).disabled = false);
                document.getElementById('editPaymentDate').disabled = false;
                document.getElementById('editProgress').disabled = false;
                document.getElementById('editNotes').disabled = false;
            }
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                schoolName: document.getElementById('editSchoolName').value,
                amount: parseAmount(document.getElementById('editAmount').value),
                dueDate: document.getElementById('editDueDate').value,
                paymentDate: document.getElementById('editPaymentDate').value,
                progress: document.getElementById('editProgress').value,
                assignedTo: document.getElementById('editAssignedTo').value,
                phone: document.getElementById('editPhone').value,
                notes: document.getElementById('editNotes').value,
                lastUpdated: getCurrentDateTimeISO()
            };

            try {
                const apiUrl = document.getElementById('sheetsUrl').value.trim();
                const usingApi = isAppsScriptUrl(apiUrl);

                if (editingIndex === -1) {
                    // æ–°è¦è¿½åŠ 
                    if (currentUser.role !== 'admin') { 
                        alert('æ–°è¦è¿½åŠ ã¯ç®¡ç†è€…ã®ã¿å¯èƒ½ã§ã™'); 
                        return; 
                    }
                    
                    if (usingApi) {
                        await sendAddRecordToServer(formData);
                        showSyncIndicator('æ–°è¦è¿½åŠ å®Œäº†', 'success');
                        await syncFromSheets();
                    } else {
                        allData.push({ ...formData, customerCode: '', version: 1 });
                        addEditHistory(formData.schoolName, 'æ–°è¦è¿½åŠ ', '', 'ãƒ‡ãƒ¼ã‚¿ä½œæˆ', 'CREATE');
                        localStorage.setItem('jukuSystemData', JSON.stringify(allData));
                        populateAssignedToFilter();
                        applyAllFilters();
                        updateLastEditInfo();
                    }
                } else {
                    // ç·¨é›†
                    const originalIndex = allData.indexOf(filteredData[editingIndex]);
                    const oldData = allData[originalIndex];
                    
                    formData.customerCode = oldData.customerCode || '';
                    formData.version = oldData.version || 1;

                    if (currentUser.role === 'staff') {
                        const allowed = ['paymentDate', 'progress', 'notes'];
                        Object.keys(formData).forEach(key => {
                            if (!allowed.includes(key) && key !== 'lastUpdated' && key !== 'version' && key !== 'customerCode') {
                                formData[key] = oldData[key];
                            }
                        });
                    }

                    if (usingApi) {
                        const updateSuccess = await sendUpdatesToServer([formData]);
                        if (!updateSuccess) { 
                            closeModal(); 
                            return; 
                        }
                        await syncFromSheets();
                    } else {
                        const fieldNames = {
                            schoolName: 'è«‹æ±‚å…ˆå', amount: 'æœªåé‡‘é¡', dueDate: 'æœŸæ—¥',
                            paymentDate: 'å…¥é‡‘äºˆå®šæ—¥', progress: 'é€²æ—', assignedTo: 'æ‹…å½“è€…',
                            phone: 'é›»è©±ç•ªå·', notes: 'å‚™è€ƒ'
                        };
                        Object.keys(formData).forEach(key => {
                            if (key !== 'lastUpdated' && key !== 'customerCode' && key !== 'version' && oldData[key] !== formData[key]) {
                                addEditHistory(formData.schoolName, fieldNames[key], oldData[key], formData[key], 'UPDATE');
                            }
                        });
                        allData[originalIndex] = formData;
                        localStorage.setItem('jukuSystemData', JSON.stringify(allData));
                        
                        // ç·¨é›†å±¥æ­´ãƒãƒƒãƒ—ã‚’å†æ§‹ç¯‰
                        buildSchoolLastEditMap();
                        
                        populateAssignedToFilter();
                        applyAllFilters();
                        updateLastEditInfo();
                    }
                }
                closeModal();
            } catch (error) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        });

        // â˜…ä¿®æ­£ï¼šå±¥æ­´è¿½åŠ æ™‚ã«ç·¨é›†å±¥æ­´ãƒãƒƒãƒ—ã‚’æ›´æ–°
        function addEditHistory(schoolName, field, oldValue, newValue, action) {
            const historyEntry = {
                id: Date.now() + Math.random(),
                schoolName: schoolName,
                editedBy: currentUser.name,
                editDate: new Date().toISOString(),
                field: field,
                oldValue: oldValue || '',
                newValue: newValue || '',
                action: action
            };
            editHistory.push(historyEntry);
            localStorage.setItem('editHistory', JSON.stringify(editHistory));
            
            // ç·¨é›†å±¥æ­´ãƒãƒƒãƒ—ã‚’å†æ§‹ç¯‰
            buildSchoolLastEditMap();
            
            updateLastEditInfo(); // å±¥æ­´è¿½åŠ æ™‚ã«æœ€çµ‚ç·¨é›†æƒ…å ±ã‚’æ›´æ–°
        }

        // è¨­å®šé–¢é€£ã®é–¢æ•°
        function showSettings() {
            document.getElementById('settingsPanel').style.display = 'block';
        }

        function hideSettings() {
            document.getElementById('settingsPanel').style.display = 'none';
        }

        function saveSettings() {
            const rawUrl = document.getElementById('sheetsUrl').value.trim();
            
            if (!isAppsScriptUrl(rawUrl)) {
                alert('Apps Scriptã®Webã‚¢ãƒ—ãƒªURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const settings = {
                sheetsUrl: rawUrl,
                autoUpdateInterval: document.getElementById('autoUpdateInterval').value
            };
            
            localStorage.setItem('appSettings', JSON.stringify(settings));
            setupAutoUpdate();
            
            alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆåŒæ–¹å‘åŒæœŸãƒ¢ãƒ¼ãƒ‰ï¼‰');
        }

        function loadSettings() {
            const settings = localStorage.getItem('appSettings');
            if (settings) {
                const parsed = JSON.parse(settings);
                document.getElementById('sheetsUrl').value = parsed.sheetsUrl || '';
                document.getElementById('autoUpdateInterval').value = parsed.autoUpdateInterval || '30000';
            }
            
            const history = localStorage.getItem('editHistory');
            if (history) {
                editHistory = JSON.parse(history);
                // ç·¨é›†å±¥æ­´ãƒãƒƒãƒ—ã‚’æ§‹ç¯‰
                buildSchoolLastEditMap();
                updateLastEditInfo(); // è¨­å®šèª­ã¿è¾¼ã¿æ™‚ã«æœ€çµ‚ç·¨é›†æƒ…å ±ã‚’æ›´æ–°
            }
        }

        function setupAutoUpdate() {
            if (autoUpdateTimer) { 
                clearInterval(autoUpdateTimer); 
                autoUpdateTimer = null; 
            }
            
            const interval = parseInt(document.getElementById('autoUpdateInterval').value);
            if (interval > 0) {
                autoUpdateTimer = setInterval(() => {
                    const url = document.getElementById('sheetsUrl').value.trim();
                    if (url) syncFromSheets();
                }, interval);
                showSyncIndicator(`è‡ªå‹•åŒæœŸé–‹å§‹ (${interval/1000}ç§’é–“éš”)`, 'info');
            }
        }

        function refreshData() {
            syncFromSheets();
        }

        function resetLocalData() {
            const firstConfirm = confirm(
                'å…¨ã¦ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\n' +
                'å‰Šé™¤ã•ã‚Œã‚‹å†…å®¹ï¼š\n' +
                'â€¢ è¡¨ç¤ºä¸­ã®å¡¾ç®¡ç†ãƒ‡ãƒ¼ã‚¿\n' +
                'â€¢ ã‚·ã‚¹ãƒ†ãƒ å†…ã§ç·¨é›†ã—ãŸé€²æ—ãƒ»å…¥é‡‘äºˆå®šæ—¥ãƒ»å‚™è€ƒ\n' +
                'â€¢ ç·¨é›†å±¥æ­´\n' +
                'â€¢ æ¥ç¶šè¨­å®š\n\n' +
                'Google Sheetsã®ãƒ‡ãƒ¼ã‚¿ã«ã¯å½±éŸ¿ã—ã¾ã›ã‚“ã€‚'
            );
            if (!firstConfirm) return;
            
            const finalConfirm = confirm(
                'æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\n' +
                'âš ï¸ é‡è¦ãªè­¦å‘Šï¼š\n' +
                'ã‚·ã‚¹ãƒ†ãƒ å†…ã§ç·¨é›†ã—ãŸå†…å®¹ã¯å®Œå…¨ã«å¤±ã‚ã‚Œã¾ã™ã€‚\n' +
                'ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚'
            );
            if (!finalConfirm) return;
            
            try {
                localStorage.removeItem('jukuSystemData');
                localStorage.removeItem('editHistory');
                localStorage.removeItem('appSettings');
                allData = [];
                editHistory = [];
                schoolLastEditMap.clear(); // ãƒãƒƒãƒ—ã‚‚ã‚¯ãƒªã‚¢
                currentAssignedToFilter = '';
                if (autoUpdateTimer) { 
                    clearInterval(autoUpdateTimer); 
                    autoUpdateTimer = null; 
                }
                populateAssignedToFilter();
                applyAllFilters();
                updateEmptyState();
                updateLastEditInfo();
                showSyncIndicator('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'success');
            } catch (error) {
                console.error('Reset error:', error);
                showSyncIndicator('ãƒªã‚»ãƒƒãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        function exportToExcel() {
            if (!requireAdminAccess('Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ')) return;
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(allData.map(row => ({
                'å¾—æ„å…ˆã‚³ãƒ¼ãƒ‰': row.customerCode || '',
                'è«‹æ±‚å…ˆå': row.schoolName,
                'æœªåé‡‘é¡': parseAmount(row.amount),
                'æœŸæ—¥': row.dueDate,
                'å…¥é‡‘äºˆå®šæ—¥': row.paymentDate || '',
                'é€²æ—': row.progress,
                'æ‹…å½“': row.assignedTo,
                'é›»è©±ç•ªå·': row.phone || '',
                'æœ€çµ‚æ›´æ–°': formatSchoolLastEdit(row.schoolName), // ç·¨é›†å±¥æ­´ãƒ™ãƒ¼ã‚¹
                'å‚™è€ƒ': row.notes || '',
                'ãƒãƒ¼ã‚¸ãƒ§ãƒ³': row.version || 1
            })));
            
            XLSX.utils.book_append_sheet(wb, ws, 'ãƒ‡ãƒ¼ã‚¿');
            XLSX.writeFile(wb, 'juku_data_v29.xlsx');
        }

        // ãã®ä»–ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function showError(element, message) {
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => { element.style.display = 'none'; }, 3000);
        }

        // â˜…ä¿®æ­£ï¼šãƒ†ãƒ¼ãƒ–ãƒ«ã‚½ãƒ¼ãƒˆã§ã‚‚ç·¨é›†å±¥æ­´ãƒ™ãƒ¼ã‚¹ã®æœ€çµ‚æ›´æ–°ã‚’ä½¿ç”¨
        function sortTable(columnIndex) {
            if (sortColumn === columnIndex) {
                sortDirection *= -1;
            } else {
                sortColumn = columnIndex;
                sortDirection = 1;
            }

            const sortKeys = ['schoolName', 'amount', 'dueDate', null, 'paymentDate', 'progress', 'assignedTo', 'phone', 'lastUpdated', 'notes'];
            const key = sortKeys[columnIndex];

            const nonZeroRecords = filteredData.filter(row => !isZeroAmountRecord(row));
            const zeroRecords = filteredData.filter(row => isZeroAmountRecord(row));

            const sortFunction = (a, b) => {
                let aVal, bVal;

                if (columnIndex === 1) {
                    aVal = parseAmount(a.amount) || 0;
                    bVal = parseAmount(b.amount) || 0;
                    return (aVal - bVal) * sortDirection;
                } else if (columnIndex === 2 || columnIndex === 4) {
                    aVal = new Date(a[key] || '1900-01-01');
                    bVal = new Date(b[key] || '1900-01-01');
                    return (aVal - bVal) * sortDirection;
                } else if (columnIndex === 3) {
                    const aOverdue = calculateOverdueDays(a.dueDate);
                    const bOverdue = calculateOverdueDays(b.dueDate);
                    
                    if (aOverdue === null && bOverdue === null) return 0;
                    if (aOverdue === null) return sortDirection;
                    if (bOverdue === null) return -sortDirection;
                    
                    return (aOverdue - bOverdue) * sortDirection;
                } else if (columnIndex === 8) {
                    // â˜…ä¿®æ­£ï¼šç·¨é›†å±¥æ­´ãƒ™ãƒ¼ã‚¹ã®æœ€çµ‚æ›´æ–°ã§ã‚½ãƒ¼ãƒˆ
                    aVal = getSchoolLastEditTime(a.schoolName) || new Date('1900-01-01');
                    bVal = getSchoolLastEditTime(b.schoolName) || new Date('1900-01-01');
                    return (aVal - bVal) * sortDirection;
                } else {
                    aVal = (a[key] || '').toString();
                    bVal = (b[key] || '').toString();
                    return aVal.localeCompare(bVal) * sortDirection;
                }
            };

            nonZeroRecords.sort(sortFunction);
            zeroRecords.sort(sortFunction);
            filteredData = [...nonZeroRecords, ...zeroRecords];
            renderTable();
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        window.onclick = function(event) {
            const editModal = document.getElementById('editModal');
            const historyModal = document.getElementById('historyModal');
            if (event.target === editModal) closeModal();
            if (event.target === historyModal) closeHistoryModal();
        }

        window.addEventListener('resize', function() { 
            updateEmptyState(); 
        });

        window.addEventListener('online', () => {
            const url = document.getElementById('sheetsUrl').value.trim();
            if (url) {
                console.log('ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¾©å¸° - è‡ªå‹•åŒæœŸå®Ÿè¡Œ');
                syncFromSheets();
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
            
            try {
                const savedUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
                if (savedUser && savedUser.id && accounts[savedUser.id]) {
                    currentUser = savedUser;
                    showMainScreen();
                }
            } catch (error) {
                console.log('Auto-login failed, showing login screen');
            }
        });

        // å¿…è¦ãªé–¢æ•°ã®è¿½åŠ å®Ÿè£…ï¼ˆå‰Šé™¤ã€ä¸€æ‹¬å‰Šé™¤ã€æ–°è¦è¿½åŠ ã‚µãƒ¼ãƒãƒ¼é€ä¿¡ãªã©ï¼‰
        async function sendAddRecordToServer(recordData) {
            const apiUrl = document.getElementById('sheetsUrl').value.trim();
            if (!isAppsScriptUrl(apiUrl)) throw new Error('API URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'text/plain;charset=utf-8'
                },
                body: JSON.stringify({ action: 'addRecord', record: recordData })
            });
            
            if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            const result = await response.json();
            if (result.error) throw new Error(result.error);
            return result;
        }

        async function deleteRecord(index) {
            if (!shouldShowDeleteButton()) { 
                alert('å‰Šé™¤æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“'); 
                return; 
            }
            
            const record = filteredData[index];
            if (!confirm(`${record.schoolName} ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

            const apiUrl = document.getElementById('sheetsUrl').value.trim();
            const usingApi = isAppsScriptUrl(apiUrl);

            try {
                if (usingApi) {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'text/plain;charset=utf-8'
                        },
                        body: JSON.stringify({ action: 'deleteRecord', customerCode: record.customerCode })
                    });
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    const result = await response.json();
                    if (result.error) throw new Error(result.error);
                    
                    showSyncIndicator('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å‰Šé™¤å®Œäº†', 'success');
                    await syncFromSheets();
                } else {
                    addEditHistory(record.schoolName, 'ãƒ‡ãƒ¼ã‚¿å‰Šé™¤', 'å­˜åœ¨', 'å‰Šé™¤æ¸ˆã¿', 'DELETE');
                    const originalIndex = allData.indexOf(record);
                    if (originalIndex >= 0) allData.splice(originalIndex, 1);
                    localStorage.setItem('jukuSystemData', JSON.stringify(allData));
                    populateAssignedToFilter();
                    applyAllFilters();
                    updateLastEditInfo();
                    alert(`${record.schoolName} ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸ`);
                }
            } catch (error) {
                console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        async function bulkDeleteCompleted() {
            if (!requireAdminAccess('0å††æ¡ˆä»¶ä¸€æ‹¬å‰Šé™¤')) return;
            
            const targets = allData.filter(r => isZeroAmountRecord(r));
            if (targets.length === 0) { 
                alert('å‰Šé™¤å¯¾è±¡ï¼ˆ0å††æ¡ˆä»¶ï¼‰ãŒã‚ã‚Šã¾ã›ã‚“'); 
                return; 
            }

            const apiUrl = document.getElementById('sheetsUrl').value.trim();
            const usingApi = isAppsScriptUrl(apiUrl);

            const firstConfirm = confirm(
                usingApi
                ? `0å††æ¡ˆä»¶ ${targets.length}ä»¶ã‚’å®Œå…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\n` +
                  `âš ï¸ ã‚¿ã‚¹ã‚¯å®Œäº†ã«ã‚ˆã‚‹å®Œå…¨å‰Šé™¤ã§ã™ã€‚ãƒ¬ã‚³ãƒ¼ãƒ‰æœ¬ä½“ã¨é–¢é€£ã™ã‚‹å…¨å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã€‚`
                : `0å††æ¡ˆä»¶ ${targets.length}ä»¶ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆã‚µãƒ¼ãƒãƒ¼é€£æºãªã—ï¼‰`
            );
            if (!firstConfirm) return;
            
            const finalConfirm = confirm('æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚');
            if (!finalConfirm) return;

            try {
                if (usingApi) {
                    showSyncIndicator('0å††æ¡ˆä»¶ã‚’å®Œå…¨å‰Šé™¤ä¸­...', 'info');
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'text/plain;charset=utf-8'
                        },
                        body: JSON.stringify({ action: 'bulkDeleteCompleted' })
                    });
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    const result = await response.json();
                    if (result.error) throw new Error(result.error);
                    
                    showSyncIndicator(`å®Œå…¨å‰Šé™¤å®Œäº†: ${result.deletedCount}ä»¶`, 'success');
                    alert(`å®Œå…¨å‰Šé™¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼ˆ${result.deletedCount}ä»¶ï¼‰`);
                    await syncFromSheets();
                } else {
                    targets.forEach(rec =>
                        addEditHistory(rec.schoolName, 'ä¸€æ‹¬å‰Šé™¤(0å††)', 'å­˜åœ¨', 'å‰Šé™¤æ¸ˆã¿', 'BULK_DELETE')
                    );
                    allData = allData.filter(r => !isZeroAmountRecord(r));
                    localStorage.setItem('jukuSystemData', JSON.stringify(allData));
                    
                    // ç·¨é›†å±¥æ­´ãƒãƒƒãƒ—ã‚’å†æ§‹ç¯‰
                    buildSchoolLastEditMap();
                    
                    populateAssignedToFilter();
                    applyAllFilters();
                    updateLastEditInfo();
                    alert(`${targets.length}ä»¶ã®0å††æ¡ˆä»¶ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸ`);
                }
            } catch (error) {
                console.error('0å††æ¡ˆä»¶å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                showSyncIndicator('å‰Šé™¤å¤±æ•—: ' + error.message, 'error');
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
    </script>
</body>
</html>
